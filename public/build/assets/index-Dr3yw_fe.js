import{c as be,j as t,a as rt,t as V,r as at,H as ut}from"./app-DKMZLzfm.js";import{S as zt,P as Ut}from"./public-layout-D4twQpY6.js";import{r as c,l as Ht,E as Gt,u as Kt,b as Vt,P as qt}from"./stripe-DEhpSmJl.js";import{c as Ae,a as re,B as se}from"./button-BpuFCFGL.js";import{D as ft,a as Je,b as Qe,c as xt,d as et,e as ht,f as tt}from"./dialog-Cz8pX6eT.js";import{C as _e}from"./check-DDIrKLVA.js";import{R as pt,A as Yt,a as Xt,b as Wt}from"./alert-BCP0mLK9.js";import{M as Ce}from"./map-pin-6HZ9aDy_.js";import{C as nt,X as Ge}from"./x-CVwgNE2J.js";import{C as He}from"./clock-Br7JvzSP.js";import{U as kt}from"./sheet-COscS31w.js";import{f as Ie}from"./format-BqGRHkU_.js";import{C as $e}from"./checkbox-DvFPy7ur.js";import{I as ge}from"./input-aT928qqq.js";import{H as ot}from"./house-DAg0O8J9.js";import{B as Zt}from"./building-2-CwnpVxhn.js";import{S as St}from"./search-CYN13Cpu.js";import{C as _t}from"./chevron-left-v9wYfmOk.js";import{P as Jt,a as Qt,b as es,C as ts}from"./popover-zwJGBpQI.js";import{T as ss}from"./triangle-alert-CCiXtfJA.js";import{u as Ct,N as rs,M as Pt,L as as,I as ns,m as Te}from"./location-selector-map-Cut6Ba49.js";import{L as Be}from"./label-CLkqaWUk.js";import{L as De}from"./loader-circle-C-jBiGq1.js";import{C as Mt}from"./chevron-up-BgviQ73B.js";import{C as Et}from"./chevron-down-Ob_WsXKC.js";import{S as qe,a as Ye,b as Xe,c as We,d as ve}from"./select-CiS82dEB.js";import{B as Tt}from"./badge-0S-twSfP.js";import{S as st}from"./star-Bdy812Pn.js";import{T as os}from"./textarea-Ci8ghLTv.js";import{U as is,C as ls,a as gt}from"./index-Cns2SMks.js";import{M as Lt}from"./mail-B1fny5qI.js";/* empty css            */import"./mapbox-fioGkFd4.js";import"./index-b6iZoh8X.js";import"./index-B_ybs1te.js";import"./isSameDay-IV5ClnVe.js";import"./index--92RBgGL.js";import"./google-maps-DaoVeR9E.js";import"./index-BdQq_4o_.js";import"./index-CO8lL1Hs.js";const cs=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],ds=Ae("ArrowRight",cs);const ms=[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]],bt=Ae("Award",ms);const us=[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]],fs=Ae("List",us);const xs=[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]],hs=Ae("LogIn",xs);const ps=[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]],gs=Ae("SlidersHorizontal",ps);const bs=[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]],vs=Ae("Tag",bs);const ys=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],js=Ae("UserPlus",ys),Dt=c.createContext(void 0),ze="bloodathome_booking_draft",Ns=3600*1e3,Ze={step:"collection",collectionType:null,isNhsTest:!1,selectedServices:[],location:null,selectedDate:null,timeOfDay:null,selectedSlot:null,selectedProvider:null,bookedServices:[],providerServicePrices:{},patientDetails:null,draftId:null,paymentIntentClientSecret:null,totalAmount:0,promoCode:void 0,discount:void 0,confirmationNumber:null};function ws(s){const e=be.c(38),{children:r}=s,[i,d]=c.useState(Ze),[l,y]=c.useState(!1);let a,b;e[0]===Symbol.for("react.memo_cache_sentinel")?(a=()=>{try{const I=localStorage.getItem(ze);if(I){const $=JSON.parse(I);if($._savedAt){const Ne=new Date($._savedAt).getTime();if(Date.now()-Ne>Ns){localStorage.removeItem(ze),y(!0);return}}$.selectedDate&&($.selectedDate=new Date($.selectedDate)),delete $._savedAt,d({...Ze,...$})}}catch(I){console.error("Error loading booking draft:",I)}y(!0)},b=[],e[0]=a,e[1]=b):(a=e[0],b=e[1]),c.useEffect(a,b);let m,n;e[2]!==l||e[3]!==i?(m=()=>{if(l)try{const I={...i,paymentIntentClientSecret:null,_savedAt:new Date().toISOString()};localStorage.setItem(ze,JSON.stringify(I))}catch(I){console.error("Error saving booking draft:",I)}},n=[i,l],e[2]=l,e[3]=i,e[4]=m,e[5]=n):(m=e[4],n=e[5]),c.useEffect(m,n);let u;e[6]===Symbol.for("react.memo_cache_sentinel")?(u=I=>{d($=>({...$,step:I})),window.scrollTo({top:0,behavior:"smooth"})},e[6]=u):u=e[6];const p=u;let w;e[7]===Symbol.for("react.memo_cache_sentinel")?(w=I=>{d($=>({...$,collectionType:I}))},e[7]=w):w=e[7];const R=w;let _;e[8]===Symbol.for("react.memo_cache_sentinel")?(_=I=>{d($=>({...$,isNhsTest:I}))},e[8]=_):_=e[8];const T=_;let P;e[9]===Symbol.for("react.memo_cache_sentinel")?(P=I=>{d($=>({...$,selectedServices:I}))},e[9]=P):P=e[9];const o=P;let A;e[10]===Symbol.for("react.memo_cache_sentinel")?(A=I=>{d($=>({...$,selectedServices:[...$.selectedServices,I]}))},e[10]=A):A=e[10];const M=A;let E;e[11]===Symbol.for("react.memo_cache_sentinel")?(E=I=>{d($=>({...$,selectedServices:$.selectedServices.filter(Ne=>Ne.id!==I)}))},e[11]=E):E=e[11];const N=E;let h;e[12]===Symbol.for("react.memo_cache_sentinel")?(h=I=>{d($=>({...$,location:I}))},e[12]=h):h=e[12];const k=h;let C;e[13]===Symbol.for("react.memo_cache_sentinel")?(C=I=>{d($=>({...$,selectedDate:I}))},e[13]=C):C=e[13];const z=C;let D;e[14]===Symbol.for("react.memo_cache_sentinel")?(D=I=>{d($=>({...$,timeOfDay:I}))},e[14]=D):D=e[14];const Z=D;let q;e[15]===Symbol.for("react.memo_cache_sentinel")?(q=I=>{d($=>({...$,selectedSlot:I}))},e[15]=q):q=e[15];const g=q;let F;e[16]===Symbol.for("react.memo_cache_sentinel")?(F=I=>{d($=>({...$,selectedProvider:I}))},e[16]=F):F=e[16];const H=F;let G;e[17]===Symbol.for("react.memo_cache_sentinel")?(G=I=>{d($=>({...$,bookedServices:I}))},e[17]=G):G=e[17];const j=G;let x;e[18]===Symbol.for("react.memo_cache_sentinel")?(x=I=>{d($=>({...$,providerServicePrices:I}))},e[18]=x):x=e[18];const B=x;let U;e[19]===Symbol.for("react.memo_cache_sentinel")?(U=I=>{d($=>({...$,patientDetails:I}))},e[19]=U):U=e[19];const Y=U;let ne;e[20]===Symbol.for("react.memo_cache_sentinel")?(ne=I=>{d($=>({...$,draftId:I}))},e[20]=ne):ne=e[20];const J=ne;let ie;e[21]===Symbol.for("react.memo_cache_sentinel")?(ie=I=>{d($=>({...$,paymentIntentClientSecret:I}))},e[21]=ie):ie=e[21];const ee=ie;let te;e[22]===Symbol.for("react.memo_cache_sentinel")?(te=I=>{d($=>({...$,totalAmount:I}))},e[22]=te):te=e[22];const ae=te;let le;e[23]===Symbol.for("react.memo_cache_sentinel")?(le=I=>{d($=>({...$,promoCode:I}))},e[23]=le):le=e[23];const me=le;let Q;e[24]===Symbol.for("react.memo_cache_sentinel")?(Q=I=>{d($=>({...$,discount:I}))},e[24]=Q):Q=e[24];const de=Q;let ce;e[25]===Symbol.for("react.memo_cache_sentinel")?(ce=I=>{d($=>({...$,confirmationNumber:I}))},e[25]=ce):ce=e[25];const ue=ce;let S;e[26]===Symbol.for("react.memo_cache_sentinel")?(S=()=>{d(Ze),localStorage.removeItem(ze),window.scrollTo({top:0,behavior:"smooth"})},e[26]=S):S=e[26];const L=S;let X;e[27]!==i?(X=()=>{const I=["collection","location","provider","patient","payment","success"],$=I.indexOf(i.step);if($>0){const Ne=I[$-1],we={step:Ne},ke=I.indexOf(Ne),Fe=I.indexOf("provider");ke<Fe&&(we.selectedProvider=null,we.selectedSlot=null,we.bookedServices=[],we.providerServicePrices={}),d(Re=>({...Re,...we})),window.scrollTo({top:0,behavior:"smooth"})}},e[27]=i,e[28]=X):X=e[28];const f=X;let K;e[29]!==i?(K=I=>{const $=["collection","location","provider","patient","payment","success"],Ne=$.indexOf(i.step),we=$.indexOf(I);if(we<=Ne){const ke={step:I},Fe=$.indexOf("provider");we<Fe&&Ne>=Fe&&(ke.selectedProvider=null,ke.selectedSlot=null,ke.bookedServices=[],ke.providerServicePrices={}),d(Re=>({...Re,...ke})),window.scrollTo({top:0,behavior:"smooth"})}},e[29]=i,e[30]=K):K=e[30];const W=K;let fe;e[31]!==f||e[32]!==W||e[33]!==i?(fe={...i,setStep:p,setCollectionType:R,setIsNhsTest:T,setSelectedServices:o,addService:M,removeService:N,setLocation:k,setSelectedDate:z,setTimeOfDay:Z,setSelectedSlot:g,setSelectedProvider:H,setBookedServices:j,setProviderServicePrices:B,setPatientDetails:Y,setDraftId:J,setPaymentIntentClientSecret:ee,setTotalAmount:ae,setPromoCode:me,setDiscount:de,setConfirmationNumber:ue,clearBooking:L,goBack:f,goToStep:W},e[31]=f,e[32]=W,e[33]=i,e[34]=fe):fe=e[34];const je=fe;let Le;return e[35]!==r||e[36]!==je?(Le=t.jsx(Dt.Provider,{value:je,children:r}),e[35]=r,e[36]=je,e[37]=Le):Le=e[37],Le}function Pe(){const s=c.useContext(Dt);if(s===void 0)throw new Error("useBooking must be used within a BookingProvider");return s}const Oe=[{key:"collection",label:"Services",description:"Select your tests"},{key:"location",label:"Location & Date",description:"Where and when"},{key:"provider",label:"Provider & Time",description:"Choose professional"},{key:"patient",label:"Patient Details",description:"Your information"},{key:"payment",label:"Payment",description:"Complete booking"}];function vt(s){const e=be.c(48),{currentStep:r,onStepClick:i}=s;let d;e[0]!==r?(d=j=>j.key===r,e[0]=r,e[1]=d):d=e[1];const l=Oe.findIndex(d),{clearBooking:y}=Pe(),[a,b]=c.useState(!1);let m;e[2]!==y?(m=()=>{y(),b(!1),window.scrollTo({top:0,behavior:"smooth"})},e[2]=y,e[3]=m):m=e[3];const n=m;let u;e[4]===Symbol.for("react.memo_cache_sentinel")?(u=t.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Booking Progress"}),e[4]=u):u=e[4];let p;e[5]===Symbol.for("react.memo_cache_sentinel")?(p=t.jsx(ft,{asChild:!0,children:t.jsxs(se,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground",children:[t.jsx(pt,{className:"w-4 h-4 mr-1"}),"Start Over"]})}),e[5]=p):p=e[5];let w;e[6]===Symbol.for("react.memo_cache_sentinel")?(w=t.jsxs(Je,{children:[t.jsx(Qe,{children:"Start over?"}),t.jsx(xt,{children:"This will clear all your selections and start a new booking. This action cannot be undone."})]}),e[6]=w):w=e[6];let R;e[7]===Symbol.for("react.memo_cache_sentinel")?(R=t.jsx(se,{variant:"outline",onClick:()=>b(!1),children:"Cancel"}),e[7]=R):R=e[7];let _;e[8]!==n?(_=t.jsxs(et,{className:"sm:max-w-md",children:[w,t.jsxs(ht,{className:"gap-3",children:[R,t.jsx(se,{onClick:n,children:"Yes, start over"})]})]}),e[8]=n,e[9]=_):_=e[9];let T;e[10]!==a||e[11]!==_?(T=t.jsxs("div",{className:"flex items-center justify-between mb-6",children:[u,t.jsxs(tt,{open:a,onOpenChange:b,children:[p,_]})]}),e[10]=a,e[11]=_,e[12]=T):T=e[12];let P;e[13]!==l||e[14]!==r||e[15]!==i?(P=Oe.map((j,x)=>{const B=x<l,U=j.key===r,Y=B&&i;return t.jsxs("button",{type:"button",onClick:()=>Y&&i(j.key),disabled:!Y,className:re("w-full flex items-start gap-3 p-3 rounded-xl transition-all text-left",U&&"bg-primary/10 border border-primary",!U&&"hover:bg-accent/50",Y&&"cursor-pointer",!Y&&"cursor-default"),children:[t.jsx("div",{className:re("flex items-center justify-center w-8 h-8 rounded-full shrink-0 transition-colors",B&&"bg-primary text-primary-foreground",U&&"bg-primary text-primary-foreground",!B&&!U&&"bg-muted text-muted-foreground"),children:B?t.jsx(_e,{className:"w-4 h-4"}):t.jsx("span",{className:"text-sm font-medium",children:x+1})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:re("text-sm font-medium truncate",U?"text-primary":"text-foreground"),children:j.label}),t.jsx("div",{className:"text-xs text-muted-foreground truncate",children:j.description})]})]},j.key)}),e[13]=l,e[14]=r,e[15]=i,e[16]=P):P=e[16];let o;e[17]!==T||e[18]!==P?(o=t.jsx("div",{className:"hidden lg:block",children:t.jsxs("div",{className:"space-y-4",children:[T,P]})}),e[17]=T,e[18]=P,e[19]=o):o=e[19];const A=l+1;let M;e[20]!==A?(M=t.jsxs("span",{className:"text-sm font-medium text-foreground",children:["Step ",A," of ",Oe.length]}),e[20]=A,e[21]=M):M=e[21];const E=Oe[l]?.label;let N;e[22]!==E?(N=t.jsx("span",{className:"text-xs text-muted-foreground",children:E}),e[22]=E,e[23]=N):N=e[23];let h;e[24]===Symbol.for("react.memo_cache_sentinel")?(h=t.jsx(ft,{asChild:!0,children:t.jsxs(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-foreground",children:[t.jsx(pt,{className:"w-3 h-3 mr-1"}),"Reset"]})}),e[24]=h):h=e[24];let k;e[25]===Symbol.for("react.memo_cache_sentinel")?(k=t.jsxs(Je,{children:[t.jsx(Qe,{children:"Start over?"}),t.jsx(xt,{children:"This will clear all your selections and start a new booking. This action cannot be undone."})]}),e[25]=k):k=e[25];let C;e[26]===Symbol.for("react.memo_cache_sentinel")?(C=t.jsx(se,{variant:"outline",onClick:()=>b(!1),children:"Cancel"}),e[26]=C):C=e[26];let z;e[27]!==n?(z=t.jsxs(et,{className:"sm:max-w-md",children:[k,t.jsxs(ht,{className:"gap-3",children:[C,t.jsx(se,{onClick:n,children:"Yes, start over"})]})]}),e[27]=n,e[28]=z):z=e[28];let D;e[29]!==a||e[30]!==z?(D=t.jsxs(tt,{open:a,onOpenChange:b,children:[h,z]}),e[29]=a,e[30]=z,e[31]=D):D=e[31];let Z;e[32]!==N||e[33]!==D?(Z=t.jsxs("div",{className:"flex items-center gap-2",children:[N,D]}),e[32]=N,e[33]=D,e[34]=Z):Z=e[34];let q;e[35]!==M||e[36]!==Z?(q=t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[M,Z]}),e[35]=M,e[36]=Z,e[37]=q):q=e[37];let g;e[38]!==l?(g=Oe.map((j,x)=>t.jsx("div",{className:re("h-1 rounded-full flex-1 transition-colors",x<=l?"bg-primary":"bg-muted")},j.key)),e[38]=l,e[39]=g):g=e[39];let F;e[40]!==g?(F=t.jsx("div",{className:"flex gap-1",children:g}),e[40]=g,e[41]=F):F=e[41];let H;e[42]!==q||e[43]!==F?(H=t.jsxs("div",{className:"lg:hidden mb-6",children:[q,F]}),e[42]=q,e[43]=F,e[44]=H):H=e[44];let G;return e[45]!==o||e[46]!==H?(G=t.jsxs("aside",{className:"w-full",children:[o,H]}),e[45]=o,e[46]=H,e[47]=G):G=e[47],G}function ks(s){const e=be.c(59),{className:r}=s,{selectedServices:i,bookedServices:d,providerServicePrices:l,collectionType:y,location:a,selectedDate:b,selectedSlot:m,selectedProvider:n,discount:u,setSelectedServices:p}=Pe(),{serviceFeePercentage:w,vatPercentage:R}=rt().props,_=n&&d.length>0?d:i,T=!!n;let P,o,A,M,E,N,h,k;if(e[0]!==r||e[1]!==y||e[2]!==u||e[3]!==_||e[4]!==T||e[5]!==a||e[6]!==l||e[7]!==b||e[8]!==n||e[9]!==i||e[10]!==m||e[11]!==w||e[12]!==p||e[13]!==R){k=Symbol.for("react.early_return_sentinel");e:{const D=T?_.reduce((j,x)=>{const B=l[x.id]||0;return j+B},0):0,Z=D*(w/100),q=(D+Z)*(R/100),g=D+Z+q,F=u?g-u:g;let H;e[22]!==i||e[23]!==p?(H=j=>{p(i.filter(x=>x.id!==j.id))},e[22]=i,e[23]=p,e[24]=H):H=e[24];const G=H;if(_.length===0&&!y){let j;e[25]!==r?(j=re("bg-card border border-border rounded-2xl p-6",r),e[25]=r,e[26]=j):j=e[26];let x,B;e[27]===Symbol.for("react.memo_cache_sentinel")?(x=t.jsx("h3",{className:"text-lg font-semibold text-foreground mb-4",children:"Booking Summary"}),B=t.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Select services to begin"}),e[27]=x,e[28]=B):(x=e[27],B=e[28]);let U;e[29]!==j?(U=t.jsxs("div",{className:j,children:[x,B]}),e[29]=j,e[30]=U):U=e[30],k=U;break e}e[31]!==r?(P=re("bg-card border border-border rounded-2xl p-6 space-y-4",r),e[31]=r,e[32]=P):P=e[32],e[33]===Symbol.for("react.memo_cache_sentinel")?(o=t.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Booking Summary"}),e[33]=o):o=e[33],e[34]!==y||e[35]!==a?(A=y&&t.jsxs("div",{className:"flex items-start gap-3 pb-3 border-b border-border",children:[t.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx(Ce,{className:"w-5 h-5 text-primary"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-sm font-medium text-foreground capitalize",children:y.replace("_"," ")}),a&&t.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:a.postcode})]})]}),e[34]=y,e[35]=a,e[36]=A):A=e[36],e[37]!==b||e[38]!==m?(M=b&&t.jsxs("div",{className:"flex items-start gap-3 pb-3 border-b border-border",children:[t.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx(nt,{className:"w-5 h-5 text-primary"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-sm font-medium text-foreground",children:Ie(b,"EEE, dd MMM yyyy")}),m&&t.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground mt-1",children:[t.jsx(He,{className:"w-3 h-3"}),m.time]})]})]}),e[37]=b,e[38]=m,e[39]=M):M=e[39],e[40]!==n?(E=n&&t.jsxs("div",{className:"flex items-start gap-3 pb-3 border-b border-border",children:[t.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx(kt,{className:"w-5 h-5 text-primary"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-sm font-medium text-foreground",children:n.user.full_name}),t.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:n.type.name})]})]}),e[40]=n,e[41]=E):E=e[41],e[42]!==_||e[43]!==G||e[44]!==T||e[45]!==l?(N=_.length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(zt,{className:"w-4 h-4 text-muted-foreground"}),t.jsxs("h4",{className:"text-sm font-medium text-foreground",children:["Selected Tests (",_.length,")"]})]}),t.jsx("div",{className:"space-y-1.5",children:_.map(j=>t.jsxs("div",{className:"flex items-center justify-between gap-2 group",children:[t.jsx("div",{className:"flex-1 min-w-0",children:t.jsx("div",{className:"text-sm text-foreground truncate",children:j.service_name})}),T?t.jsxs("div",{className:"text-sm font-medium text-foreground whitespace-nowrap",children:["£",(l[j.id]||0).toFixed(2)]}):t.jsx("button",{type:"button",onClick:()=>G(j),className:"p-1 rounded-md text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-colors","aria-label":`Remove ${j.service_name}`,children:t.jsx(Ge,{className:"w-4 h-4"})})]},j.id))})]}),e[42]=_,e[43]=G,e[44]=T,e[45]=l,e[46]=N):N=e[46],h=T&&D>0&&t.jsxs("div",{className:"space-y-2 pt-3 border-t border-border",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),t.jsxs("span",{className:"text-foreground",children:["£",D.toFixed(2)]})]}),t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsxs("span",{className:"text-muted-foreground",children:["Service Fee (",w,"%)"]}),t.jsxs("span",{className:"text-foreground",children:["£",Z.toFixed(2)]})]}),t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsxs("span",{className:"text-muted-foreground",children:["VAT (",R,"%)"]}),t.jsxs("span",{className:"text-foreground",children:["£",q.toFixed(2)]})]}),u&&u>0&&t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsx("span",{className:"text-green-600 dark:text-green-400",children:"Discount"}),t.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["-£",u.toFixed(2)]})]}),t.jsxs("div",{className:"flex items-center justify-between text-base font-semibold pt-2 border-t border-border",children:[t.jsx("span",{className:"text-foreground",children:"Total"}),t.jsxs("span",{className:"text-primary",children:["£",F.toFixed(2)]})]})]})}e[0]=r,e[1]=y,e[2]=u,e[3]=_,e[4]=T,e[5]=a,e[6]=l,e[7]=b,e[8]=n,e[9]=i,e[10]=m,e[11]=w,e[12]=p,e[13]=R,e[14]=P,e[15]=o,e[16]=A,e[17]=M,e[18]=E,e[19]=N,e[20]=h,e[21]=k}else P=e[14],o=e[15],A=e[16],M=e[17],E=e[18],N=e[19],h=e[20],k=e[21];if(k!==Symbol.for("react.early_return_sentinel"))return k;let C;e[47]!==_.length||e[48]!==T?(C=!T&&_.length>0&&t.jsx("div",{className:"pt-3 border-t border-border",children:t.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Prices will be shown after selecting a provider"})}),e[47]=_.length,e[48]=T,e[49]=C):C=e[49];let z;return e[50]!==P||e[51]!==o||e[52]!==A||e[53]!==M||e[54]!==E||e[55]!==N||e[56]!==h||e[57]!==C?(z=t.jsxs("div",{className:P,children:[o,A,M,E,N,h,C]}),e[50]=P,e[51]=o,e[52]=A,e[53]=M,e[54]=E,e[55]=N,e[56]=h,e[57]=C,e[58]=z):z=e[58],z}function Se(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}function Ke(){return{fetchServices:async m=>{try{const n=m?`/api/services?collection_type=${m}`:"/api/services",u=await fetch(n,{headers:{Accept:"application/json","X-CSRF-TOKEN":Se()}});if(!u.ok)throw new Error("Failed to fetch services");const p=await u.json();return p.services||p}catch(n){throw console.error("Error fetching services:",n),n}},fetchCollectionTypes:async()=>{try{const m=await fetch("/api/collection-types",{headers:{Accept:"application/json","X-CSRF-TOKEN":Se()}});if(!m.ok)throw new Error("Failed to fetch collection types");const n=await m.json();return n.collectionTypes||n}catch(m){throw console.error("Error fetching collection types:",m),m}},searchProviders:async m=>{try{const n=await fetch("/api/providers/search",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":Se()},body:JSON.stringify({latitude:m.lat,longitude:m.lng,service_ids:m.service_ids,collection_type:m.collection_type,radius_km:m.radius_km})});if(!n.ok){const p=await n.json().catch(()=>({}));if(console.error("Provider search failed:",n.status,p),n.status===422&&p.errors){const w=Object.values(p.errors).flat().join(". ");throw new Error(w||p.message||"Validation failed")}throw new Error(p.message||`Failed to search providers (${n.status})`)}const u=await n.json();return u.data?.providers||u.providers||[]}catch(n){throw console.error("Error searching providers:",n),n}},getProviderAvailability:async(m,n)=>{try{const u=await fetch(`/api/providers/${m}/availability?date=${n}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":Se()}});if(!u.ok)throw new Error("Failed to fetch provider availability");const p=await u.json();return p.data?.slots||p.slots||[]}catch(u){throw console.error("Error fetching provider availability:",u),u}},createDraft:async m=>{try{const n=await fetch("/api/booking-drafts",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":Se()},body:JSON.stringify(m)});if(!n.ok){const p=await n.json();throw new Error(p.message||"Failed to create booking draft")}const u=await n.json();return{id:u.data?.booking_id,session_token:u.data?.draft_token,total_amount:u.data?.total_cost,expires_at:u.data?.expires_at}}catch(n){throw console.error("Error creating booking draft:",n),n}},updateDraft:async(m,n)=>{try{const u=await fetch(`/api/booking-drafts/${m}`,{method:"PATCH",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":Se()},body:JSON.stringify(n)});if(!u.ok){const w=await u.json();throw new Error(w.message||"Failed to update booking draft")}const p=await u.json();return p.draft||p}catch(u){throw console.error("Error updating booking draft:",u),u}},createPaymentIntent:async m=>{try{const n=await fetch("/api/booking-drafts/payment-intent",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":Se()},body:JSON.stringify({booking_id:m})});if(!n.ok){const p=await n.json();throw new Error(p.message||"Failed to create payment intent")}const u=await n.json();return{clientSecret:u.data?.client_secret,amount:u.data?.amount}}catch(n){throw console.error("Error creating payment intent:",n),n}},applyPromoCode:async(m,n)=>{try{const u=await fetch(`/api/booking-drafts/${m}/promo-code`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":Se()},body:JSON.stringify({code:n})});if(!u.ok){const w=await u.json();throw new Error(w.message||"Invalid promo code")}const p=await u.json();return{discount:p.discount,newTotal:p.newTotal,code:p.code}}catch(u){throw console.error("Error applying promo code:",u),u}},confirmBooking:async(m,n)=>{try{const u=await fetch("/api/bookings/confirm",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":Se()},body:JSON.stringify({payment_intent_id:m,draft_id:n})});if(!u.ok){const w=await u.json();throw new Error(w.message||"Failed to confirm booking")}const p=await u.json();return{bookingId:p.data?.booking?.id,confirmationNumber:p.data?.confirmation_number}}catch(u){throw console.error("Error confirming booking:",u),u}}}}function yt(){const{collectionType:s,isNhsTest:e,selectedServices:r,setCollectionType:i,setIsNhsTest:d,setSelectedServices:l,setStep:y}=Pe(),{fetchServices:a,fetchCollectionTypes:b}=Ke(),[m,n]=c.useState([]),[u,p]=c.useState([]),[w,R]=c.useState([]),[_,T]=c.useState(""),[P,o]=c.useState(!0);c.useEffect(()=>{(async()=>{o(!0);try{const[h,k]=await Promise.all([b(),a()]);n(h),p(k),R(k)}catch(h){V.error("Failed to load services"),console.error("Error loading data:",h)}finally{o(!1)}})()},[]),c.useEffect(()=>{if(!_.trim()){R(u);return}const N=_.toLowerCase(),h=u.filter(k=>k.service_name?.toLowerCase().includes(N)||k.service_code?.toLowerCase().includes(N)||k.service_description?.toLowerCase().includes(N)||k.category?.name?.toLowerCase().includes(N));R(h)},[_,u]);const A=N=>{i(N)},M=N=>{const h=r.some(k=>k.id===N.id);l(h?r.filter(k=>k.id!==N.id):[...r,N])},E=()=>{if(!s){V.error("Please select a collection type");return}if(r.length===0){V.error("Please select at least one service");return}y("location")};return P?t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-semibold text-foreground mb-2",children:"Choose Your Test"}),t.jsx("p",{className:"text-muted-foreground",children:"Select collection type and services you need"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Collection Type"}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[t.jsx("button",{type:"button",onClick:()=>A("home_visit"),className:re("p-4 rounded-xl border-2 transition-all text-left",s==="home_visit"?"border-primary bg-primary/5":"border-border hover:border-primary/50"),children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:re("w-10 h-10 rounded-lg flex items-center justify-center shrink-0",s==="home_visit"?"bg-primary":"bg-muted"),children:t.jsx(ot,{className:re("w-5 h-5",s==="home_visit"?"text-primary-foreground":"text-foreground")})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-medium text-foreground",children:"Home Visit"}),t.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"Professional visits your location"})]}),s==="home_visit"&&t.jsx(_e,{className:"w-5 h-5 text-primary shrink-0"})]})}),t.jsx("button",{type:"button",onClick:()=>A("clinic"),className:re("p-4 rounded-xl border-2 transition-all text-left",s==="clinic"?"border-primary bg-primary/5":"border-border hover:border-primary/50"),children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:re("w-10 h-10 rounded-lg flex items-center justify-center shrink-0",s==="clinic"?"bg-primary":"bg-muted"),children:t.jsx(Zt,{className:re("w-5 h-5",s==="clinic"?"text-primary-foreground":"text-foreground")})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-medium text-foreground",children:"Clinic Visit"}),t.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"Visit a clinic location"})]}),s==="clinic"&&t.jsx(_e,{className:"w-5 h-5 text-primary shrink-0"})]})})]})]}),t.jsxs("div",{className:"flex items-center gap-3 p-4 bg-accent/30 rounded-xl border border-border",children:[t.jsx($e,{id:"nhs-test",checked:e,onCheckedChange:N=>d(N===!0)}),t.jsx("label",{htmlFor:"nhs-test",className:"text-sm text-foreground cursor-pointer flex-1",children:"This is an NHS test (requires NHS number)"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Select Services"}),r.length>0&&t.jsxs("span",{className:"text-xs text-muted-foreground",children:[r.length," selected"]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(St,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),t.jsx(ge,{type:"text",placeholder:"Search services...",value:_,onChange:N=>T(N.target.value),className:"pl-10 pr-10"}),_&&t.jsx("button",{type:"button",onClick:()=>T(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground",children:t.jsx(Ge,{className:"w-4 h-4"})})]}),t.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:w.length===0?t.jsx("div",{className:"text-center py-8 text-muted-foreground",children:t.jsx("p",{children:"No services found"})}):w.map(N=>{const h=r.some(k=>k.id===N.id);return t.jsx("button",{type:"button",onClick:()=>M(N),className:re("w-full p-4 rounded-xl border transition-all text-left",h?"border-primary bg-primary/5":"border-border hover:border-primary/50"),role:"checkbox","aria-checked":h,"aria-label":N.service_name,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:re("w-5 h-5 rounded border-2 flex items-center justify-center shrink-0 mt-0.5",h?"bg-primary border-primary":"border-muted-foreground"),"aria-hidden":"true",children:h&&t.jsx(_e,{className:"w-3 h-3 text-primary-foreground"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"font-medium text-foreground",children:N.service_name}),t.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[N.service_code," • ",N.category?.name]}),N.service_description&&t.jsx("div",{className:"text-xs text-muted-foreground mt-2 line-clamp-2",children:N.service_description})]})]})},N.id)})})]}),t.jsx("div",{className:"pt-4",children:t.jsx(se,{onClick:E,disabled:!s||r.length===0,className:"w-full py-6 text-base",size:"lg",children:"Continue to Location"})})]})}function it(s){const e=be.c(4),{label:r,onClick:i}=s;let d;e[0]===Symbol.for("react.memo_cache_sentinel")?(d=t.jsx(_t,{className:"w-4 h-4"}),e[0]=d):d=e[0];let l;return e[1]!==r||e[2]!==i?(l=t.jsxs("button",{type:"button",onClick:i,className:"flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors mb-3",children:[d,r]}),e[1]=r,e[2]=i,e[3]=l):l=e[3],l}function jt(s){const e=be.c(27),{title:r,message:i,duration:d,onDismiss:l,className:y}=s,a=d===void 0?8e3:d,[b,m]=c.useState(!1),[n,u]=c.useState(!1);let p;e[0]!==b?(p=()=>{b||m(!0)},e[0]=b,e[1]=p):p=e[1];const w=p;let R;e[2]!==w||e[3]!==a?(R=()=>{if(a<=0)return;const z=setTimeout(w,a);return()=>clearTimeout(z)},e[2]=w,e[3]=a,e[4]=R):R=e[4];let _;e[5]!==a?(_=[a],e[5]=a,e[6]=_):_=e[6],c.useEffect(R,_);let T,P;if(e[7]!==b||e[8]!==l?(T=()=>{if(!b)return;const z=setTimeout(()=>{u(!0),l?.()},300);return()=>clearTimeout(z)},P=[b,l],e[7]=b,e[8]=l,e[9]=T,e[10]=P):(T=e[9],P=e[10]),c.useEffect(T,P),n)return null;const o=b?"opacity-0 -translate-y-2 scale-95":"opacity-100 translate-y-0 scale-100 animate-in fade-in slide-in-from-top-2 duration-300";let A;e[11]!==y||e[12]!==o?(A=re("border-red-500 bg-red-50 text-red-800 dark:bg-red-950/30 dark:text-red-200 transition-all duration-300",o,y),e[11]=y,e[12]=o,e[13]=A):A=e[13];let M;e[14]===Symbol.for("react.memo_cache_sentinel")?(M=t.jsx(ss,{className:"h-4 w-4 text-red-600 dark:text-red-400"}),e[14]=M):M=e[14];let E;e[15]!==r?(E=t.jsx(Yt,{className:"text-red-800 dark:text-red-200 pr-6",children:r}),e[15]=r,e[16]=E):E=e[16];let N;e[17]!==i?(N=t.jsx(Xt,{className:"text-red-700 dark:text-red-300",children:i}),e[17]=i,e[18]=N):N=e[18];let h;e[19]===Symbol.for("react.memo_cache_sentinel")?(h=t.jsx(Ge,{className:"h-4 w-4"}),e[19]=h):h=e[19];let k;e[20]!==w?(k=t.jsx("button",{type:"button",onClick:w,className:"absolute top-3 right-3 text-red-400 hover:text-red-600 dark:text-red-500 dark:hover:text-red-300 transition-colors","aria-label":"Dismiss",children:h}),e[20]=w,e[21]=k):k=e[21];let C;return e[22]!==E||e[23]!==N||e[24]!==k||e[25]!==A?(C=t.jsxs(Wt,{className:A,children:[M,E,N,k]}),e[22]=E,e[23]=N,e[24]=k,e[25]=A,e[26]=C):C=e[26],C}function Ss({userAddresses:s=[],googleMapsKey:e,isAuthenticated:r=!1}){const{location:i,selectedDate:d,selectedServices:l,collectionType:y,setLocation:a,setSelectedDate:b,setStep:m,goBack:n}=Pe(),{searchProviders:u}=Ke(),{isLoaded:p,libraries:w}=Ct(e),[R,_]=c.useState(s.length>0?"saved":"new"),[T,P]=c.useState(""),[o,A]=c.useState(!1),[M,E]=c.useState(!1),[N,h]=c.useState(!1),[k,C]=c.useState(!1),[z,D]=c.useState(null),[Z,q]=c.useState(i?{lat:i.lat,lng:i.lng}:{lat:51.5074,lng:-.1278}),[g,F]=c.useState(i?.addressLine1||""),[H,G]=c.useState(i?.addressLine2||""),[j,x]=c.useState(i?.townCity||""),[B,U]=c.useState(!!i?.postcode),[Y,ne]=c.useState(!1),[J,ie]=c.useState(""),[ee,te]=c.useState(!1),[ae,le]=c.useState(""),[me,Q]=c.useState([]),[de,ce]=c.useState(!1),[ue,S]=c.useState(!1),[L,X]=c.useState(null),f=c.useRef(null),K=c.useRef(null),W=c.useRef(void 0),fe=v=>/^[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2}$/i.test(v.trim()),je=async v=>{if(!v.addressComponents||!v.location){V.error("Could not get address details");return}const O=v.addressComponents;let oe="",xe="",he="",pe="",Me="",Ee="";for(const ye of O)ye.types.includes("street_number")&&(oe=ye.longText||""),ye.types.includes("route")&&(xe=ye.longText||""),ye.types.includes("subpremise")&&(he=ye.longText||""),ye.types.includes("locality")&&(pe=ye.longText||""),ye.types.includes("postal_town")&&(Me=ye.longText||""),ye.types.includes("postal_code")&&(Ee=ye.longText||"");const lt=[oe,xe].filter(Boolean).join(" "),ct=he,Ve=Me||pe,dt=v.location.lat(),mt=v.location.lng();F(lt),G(ct),x(Ve);const Ot={postcode:Ee,lat:dt,lng:mt,address:`${Ve}`,addressLine1:lt,addressLine2:ct,townCity:Ve};a(Ot),q({lat:dt,lng:mt}),h(!1),U(!0),V.success("Address found")},Le=async(v,O)=>{if(!p||!w)return V.error("Google Maps is not loaded"),!1;try{const xe=await new google.maps.Geocoder().geocode({location:{lat:v,lng:O}});if(xe.results&&xe.results.length>0){const he=xe.results[0],pe=he.address_components.find(Ee=>Ee.types.includes("country"));if(!pe||pe.short_name!=="GB")return h(!0),!1;const Me={addressComponents:he.address_components.map(Ee=>({longText:Ee.long_name,shortText:Ee.short_name,types:Ee.types})),location:he.geometry.location};return await je(Me),!0}else return await I(v,O),!N}catch(oe){return console.error("Google reverse geocoding error:",oe),await I(v,O),!N}},I=async(v,O)=>{try{const oe=await fetch(`https://api.postcodes.io/postcodes?lon=${O}&lat=${v}&limit=1`);if(!oe.ok)throw new Error(`API responded with status ${oe.status}`);const xe=await oe.json();if(xe.status===200&&xe.result&&xe.result.length>0){const he=xe.result[0],pe={postcode:he.postcode,lat:he.latitude,lng:he.longitude,address:`${he.admin_district||""}, ${he.region||""}`.replace(/^, |, $/g,""),addressLine1:"",addressLine2:"",townCity:""};a(pe),q({lat:pe.lat,lng:pe.lng}),h(!1),U(!0)}else h(!0)}catch(oe){console.error("Postcode API error:",oe),h(!0)}};c.useEffect(()=>{p&&!L&&(async()=>{try{const{AutocompleteSessionToken:O}=await google.maps.importLibrary("places");X(new O)}catch(O){console.error("Error creating session token:",O)}})()},[p,L]);const $=c.useCallback(async v=>{if(!p||!L||v.length<5){Q([]);return}ce(!0);try{const{AutocompleteSuggestion:O}=await google.maps.importLibrary("places"),oe=await O.fetchAutocompleteSuggestions({input:v,sessionToken:L,includedRegionCodes:["gb"]});Q(oe.suggestions||[]),S(!0)}catch(O){console.error("Error fetching suggestions:",O),Q([])}finally{ce(!1)}},[p,L]),Ne=v=>{const O=v.target.value;if(le(O),W.current&&clearTimeout(W.current),O.length<5){Q([]),S(!1);return}W.current=setTimeout(()=>{$(O)},500)},we=async v=>{if(!v.placePrediction){V.error("Invalid suggestion");return}try{const O=v.placePrediction.toPlace();if(await O.fetchFields({fields:["addressComponents","location","formattedAddress"]}),!O.location){V.error("No location details available for this address");return}await je(O);const oe=v.placePrediction.structuredFormat?.mainText?.text||v.placePrediction.text?.text||"";le(oe),S(!1),Q([]);const{AutocompleteSessionToken:xe}=await google.maps.importLibrary("places");X(new xe)}catch(O){console.error("Error selecting suggestion:",O),V.error("Failed to get address details")}};c.useEffect(()=>{const v=O=>{f.current&&!f.current.contains(O.target)&&K.current&&!K.current.contains(O.target)&&S(!1)};return document.addEventListener("mousedown",v),()=>document.removeEventListener("mousedown",v)},[]),c.useEffect(()=>{const v=O=>{O.key==="Escape"&&S(!1)};return document.addEventListener("keydown",v),()=>document.removeEventListener("keydown",v)},[]);const ke=v=>{P(v.id),F(v.address_line1),G(v.address_line2||""),x(v.town_city),Fe(v.postcode,v.address_line1,v.address_line2,v.town_city)},Fe=async(v,O,oe,xe)=>{if(!fe(v)){V.error("Please enter a valid UK postcode");return}try{const pe=await(await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(v)}`)).json();if(pe.status===200&&pe.result){const Me={postcode:v.toUpperCase(),lat:pe.result.latitude,lng:pe.result.longitude,address:`${pe.result.admin_district}, ${pe.result.region}`,addressLine1:O||"",addressLine2:oe||"",townCity:xe||""};a(Me),q({lat:Me.lat,lng:Me.lng}),h(!1),U(!0),V.success("Location found")}else V.error("Postcode not found. Please check and try again.")}catch(he){console.error("Geocoding error:",he),V.error("Failed to find location. Please try again.")}},Re=()=>{if(!navigator.geolocation){V.error("Geolocation is not supported by your browser");return}E(!0),V.loading("Getting your location...",{id:"getting-location"}),navigator.geolocation.getCurrentPosition(async v=>{const O=v.coords.latitude,oe=v.coords.longitude;try{let xe=!1;p&&w?xe=await Le(O,oe):(await I(O,oe),xe=!N),xe?V.success("Current location found",{id:"getting-location"}):V.error("Your location is outside the UK. Please enter a UK address manually.",{id:"getting-location"})}catch(xe){console.error("Reverse geocoding error:",xe),h(!0),V.error("Your location is outside the UK. Please enter a UK address manually.",{id:"getting-location"})}finally{E(!1)}},v=>{console.error("Geolocation error:",v);let O="Failed to get your location";switch(v.code){case v.PERMISSION_DENIED:O="Location permission denied. Please enable location access in your browser settings.";break;case v.POSITION_UNAVAILABLE:O="Location information unavailable. Please try again or enter postcode manually.";break;case v.TIMEOUT:O="Location request timed out. Please try again.";break}V.error(O,{id:"getting-location"}),E(!1)},{enableHighAccuracy:!1,timeout:15e3,maximumAge:6e4})},$t=async v=>{try{let O=!1;p&&w?O=await Le(v.lat,v.lng):(await I(v.lat,v.lng),O=!N),O||V.error("This location is outside the UK. Please select a UK location.")}catch(O){console.error("Reverse geocoding error:",O),h(!0),V.error("This location is outside the UK. Please select a UK location.")}},Rt=async()=>{if(!i){V.error("Please enter a valid address");return}if(!g.trim()){V.error("Please enter your street address");return}if(!j.trim()){V.error("Please enter your town/city");return}if(a({...i,addressLine1:g.trim(),addressLine2:H.trim(),townCity:j.trim()}),!d){V.error("Please select a date");return}if(Y&&J.trim()&&r&&R==="new"){te(!0);try{const v=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"";await fetch("/api/addresses",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":v,Accept:"application/json"},body:JSON.stringify({label:J.trim(),address_line1:g.trim(),address_line2:H.trim()||null,town_city:j.trim(),postcode:i.postcode})}),V.success("Address saved for future bookings")}catch(v){console.error("Failed to save address:",v)}finally{te(!1)}}C(!0),D(null);try{if((await u({lat:i.lat,lng:i.lng,service_ids:l.map(oe=>oe.id),collection_type:y||void 0,radius_km:10})).length>0){m("provider");return}if((await u({lat:i.lat,lng:i.lng,service_ids:l.map(oe=>oe.id),collection_type:y||void 0,radius_km:25})).length>0){m("provider");return}D("No providers available in your area. Please try a different location or check back later.")}catch(v){console.error("Error checking providers:",v),m("provider")}finally{C(!1)}},Bt=v=>{const O=new Date;return O.setHours(0,0,0,0),v<O};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx(it,{label:"Back to Choose Your Test",onClick:n}),t.jsx("h1",{className:"text-2xl font-semibold text-foreground mb-2",children:"Location & Date"}),t.jsx("p",{className:"text-muted-foreground",children:"Where and when would you like your test?"})]}),N&&t.jsx(jt,{title:"Location not supported",message:"Our service is currently only available in the United Kingdom. Your detected location appears to be outside the UK. Please enter a valid UK postcode manually.",onDismiss:()=>h(!1)}),r&&s.length>0&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex gap-2 p-1 bg-muted rounded-lg",children:[t.jsx("button",{type:"button",onClick:()=>{_("saved"),ne(!1),ie("")},className:re("flex-1 px-4 py-2.5 text-sm font-medium rounded-md transition-all",R==="saved"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:"Saved Addresses"}),t.jsx("button",{type:"button",onClick:()=>{_("new"),P(""),F(""),G(""),x(""),U(!1),a(null)},className:re("flex-1 px-4 py-2.5 text-sm font-medium rounded-md transition-all",R==="new"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:"New Address"})]}),R==="saved"&&t.jsx("div",{className:"grid gap-3 animate-in fade-in slide-in-from-top-2 duration-300",children:s.map(v=>{const O=T===v.id;return t.jsx("button",{type:"button",onClick:()=>ke(v),className:re("p-4 rounded-xl border cursor-pointer transition-all text-left",O?"border-primary bg-primary/5 ring-2 ring-primary/20":"border-border hover:border-primary/50"),children:t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"font-medium text-foreground mb-1",children:v.label}),t.jsxs("div",{className:"text-sm text-muted-foreground",children:[v.address_line1,v.address_line2&&`, ${v.address_line2}`]}),t.jsxs("div",{className:"text-sm text-muted-foreground",children:[v.town_city,", ",v.postcode]})]}),t.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[v.is_default&&t.jsx("span",{className:"text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full",children:"Default"}),O&&t.jsx("div",{className:"w-6 h-6 rounded-full bg-primary flex items-center justify-center",children:t.jsx(_e,{className:"w-4 h-4 text-primary-foreground"})})]})]})},v.id)})})]}),(R==="new"||s.length===0)&&t.jsxs("div",{className:"space-y-3 animate-in fade-in slide-in-from-top-2 duration-300",children:[t.jsxs("label",{htmlFor:"address-search",className:"text-sm font-medium text-foreground",children:["Your Address ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(se,{type:"button",variant:"outline",onClick:Re,disabled:M,className:"flex-1 h-11",children:M?t.jsxs(t.Fragment,{children:[t.jsx(De,{className:"mr-2 h-4 w-4 animate-spin"}),"Getting Location..."]}):t.jsxs(t.Fragment,{children:[t.jsx(rs,{className:"mr-2 h-4 w-4"}),"Use Current Location"]})}),t.jsxs(se,{type:"button",variant:"outline",onClick:()=>{const v=!o;A(v),v&&(le(""),Q([]),S(!1))},className:"flex-1 h-11",children:[t.jsx(Pt,{className:"mr-2 h-4 w-4"}),o?"Hide Map":"Select on Map",o?t.jsx(Mt,{className:"ml-2 h-4 w-4"}):t.jsx(Et,{className:"ml-2 h-4 w-4"})]})]}),o&&t.jsx("div",{className:"space-y-2 animate-in fade-in slide-in-from-top-2 duration-300",children:t.jsx(as,{center:Z,zoom:13,onLocationSelect:$t})}),!o&&t.jsxs("div",{className:"space-y-2 relative",children:[t.jsx(ns,{ref:K,type:"text",placeholder:"Start typing your address...",value:ae,onChange:Ne,disabled:!p,leftIcon:t.jsx(Ce,{className:"w-5 h-5"}),rightAction:de?t.jsx(De,{className:"w-4 h-4 animate-spin text-muted-foreground"}):null,inputClassName:"h-12"}),ae.length>0&&ae.length<5&&t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Type ",5-ae.length," more character",5-ae.length!==1?"s":""," to see suggestions..."]}),!p&&t.jsx("p",{className:"text-xs text-muted-foreground",children:"Loading address search..."}),ue&&me.length>0&&t.jsx("div",{ref:f,className:"absolute z-50 w-full mt-1 bg-popover border border-border rounded-md shadow-lg max-h-60 overflow-auto",children:me.map((v,O)=>{const oe=v.placePrediction;if(!oe)return null;const xe=oe.structuredFormat?.mainText?.text||oe.text?.text||"",he=oe.structuredFormat?.secondaryText?.text||"";return t.jsxs("button",{type:"button",onClick:()=>we(v),className:"w-full text-left px-4 py-3 hover:bg-accent transition-colors border-b border-border last:border-b-0 focus:outline-none focus:bg-accent",children:[t.jsx("div",{className:"font-medium text-foreground",children:xe}),he&&t.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:he})]},oe.placeId||O)})})]}),i&&t.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600 dark:text-green-400",children:[t.jsx(Ce,{className:"w-4 h-4"}),t.jsxs("span",{children:["Location confirmed: ",i.address||i.postcode]})]})]}),B&&i&&t.jsxs("div",{className:"space-y-4 p-4 bg-accent/30 rounded-xl border border-border animate-in fade-in slide-in-from-top-2 duration-300",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(ot,{className:"w-5 h-5 text-primary"}),t.jsx("h3",{className:"text-base font-semibold text-foreground",children:"Confirm Your Address"})]}),t.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Please verify your address details are correct."}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsxs(Be,{htmlFor:"address-line1",children:["Address Line 1 ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"address-line1",type:"text",placeholder:"House/flat number and street name",value:g,onChange:v=>F(v.target.value),className:"mt-1"}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"e.g., 123 Main Street or Flat 4, Building Name"})]}),t.jsxs("div",{children:[t.jsx(Be,{htmlFor:"address-line2",children:"Address Line 2"}),t.jsx(ge,{id:"address-line2",type:"text",placeholder:"Building name, floor, etc. (optional)",value:H,onChange:v=>G(v.target.value),className:"mt-1"})]}),t.jsxs("div",{children:[t.jsxs(Be,{htmlFor:"town-city",children:["Town/City ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"town-city",type:"text",placeholder:"e.g., London",value:j,onChange:v=>x(v.target.value),className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx(Be,{htmlFor:"postcode-display",children:"Postcode"}),t.jsx(ge,{id:"postcode-display",type:"text",value:i.postcode,disabled:!0,className:"mt-1 bg-muted"})]})]}),r&&R==="new"&&t.jsxs("div",{className:"flex items-start gap-3 pt-4 border-t border-border mt-4",children:[t.jsx($e,{id:"save-address",checked:Y,onCheckedChange:v=>ne(v===!0)}),t.jsxs("div",{className:"space-y-2 flex-1",children:[t.jsx(Be,{htmlFor:"save-address",className:"text-sm font-medium cursor-pointer",children:"Save this address for future bookings"}),Y&&t.jsx(ge,{type:"text",placeholder:"e.g., Home, Work, Mum's House",value:J,onChange:v=>ie(v.target.value),className:"mt-2"})]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Preferred Date ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsxs(Jt,{children:[t.jsx(Qt,{asChild:!0,children:t.jsxs(se,{variant:"outline",className:re("w-full h-12 justify-start text-left font-normal",!d&&"text-muted-foreground"),children:[t.jsx(nt,{className:"mr-2 h-4 w-4"}),d?Ie(d,"PPP"):t.jsx("span",{children:"Pick a date"})]})}),t.jsx(es,{className:"w-auto p-0",align:"start",children:t.jsx(ts,{mode:"single",selected:d||void 0,onSelect:v=>v&&b(v),disabled:Bt,initialFocus:!0})})]})]}),z&&t.jsx(jt,{title:"No providers found",message:z,onDismiss:()=>D(null)}),t.jsx("div",{className:"flex flex-col sm:flex-row gap-3 pt-4",children:t.jsx(se,{onClick:Rt,disabled:!i||!d||k||ee||!g.trim()||!j.trim(),className:"flex-1 py-6 text-base",size:"lg",children:k||ee?t.jsxs(t.Fragment,{children:[t.jsx(De,{className:"mr-2 h-4 w-4 animate-spin"}),ee?"Saving address...":"Checking availability..."]}):"Find Providers"})})]})}function _s(s,e,r,i){const l=(r-s)*Math.PI/180,y=(i-e)*Math.PI/180,a=Math.sin(l/2)*Math.sin(l/2)+Math.cos(s*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(y/2)*Math.sin(y/2);return 6371*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}function At(s,e=.5){if(s.length===0)return[];const r=[],i=new Set;for(const d of s){if(i.has(d.id))continue;const l=s.filter(a=>i.has(a.id)?!1:a.id===d.id?!0:_s(d.latitude,d.longitude,a.latitude,a.longitude)<=e);l.forEach(a=>i.add(a.id));const y={lat:l.reduce((a,b)=>a+b.latitude,0)/l.length,lng:l.reduce((a,b)=>a+b.longitude,0)/l.length};r.push({id:l.length===1?d.id:`cluster-${d.id}`,items:l,center:y,isCluster:l.length>1})}return r}function Ft(s,e,r=.05){const i=[],d=2*Math.PI/e,l=r/111.32,y=r/(111.32*Math.cos(s.lat*Math.PI/180));for(let a=0;a<e;a++){const b=a*d-Math.PI/2;i.push({lat:s.lat+l*Math.sin(b),lng:s.lng+y*Math.cos(b)})}return i}function It(s){return s>=16?.05:s>=14?.1:s>=12?.3:s>=10?.5:1}function Cs(s){const e=be.c(14),{providers:r,userLocation:i,selectedProvider:d,onProviderClick:l,className:y}=s,{mapProvider:a,googleMapsKey:b,mapboxToken:m}=rt().props;if(a==="google"){let u;return e[0]!==y||e[1]!==b||e[2]!==l||e[3]!==r||e[4]!==d||e[5]!==i?(u=t.jsx(Ps,{providers:r,userLocation:i,selectedProvider:d,onProviderClick:l,googleMapsKey:b,className:y}),e[0]=y,e[1]=b,e[2]=l,e[3]=r,e[4]=d,e[5]=i,e[6]=u):u=e[6],u}let n;return e[7]!==y||e[8]!==m||e[9]!==l||e[10]!==r||e[11]!==d||e[12]!==i?(n=t.jsx(Ms,{providers:r,userLocation:i,selectedProvider:d,onProviderClick:l,mapboxToken:m,className:y}),e[7]=y,e[8]=m,e[9]=l,e[10]=r,e[11]=d,e[12]=i,e[13]=n):n=e[13],n}function Ps({providers:s,userLocation:e,selectedProvider:r,onProviderClick:i,googleMapsKey:d,className:l}){const{isLoaded:y,loadError:a,libraries:b}=Ct(d),m=c.useRef(null),n=c.useRef(null),u=c.useRef(null),p=c.useRef(new Map),w=c.useRef(null),[R,_]=c.useState(!1),[T,P]=c.useState(!1),[o,A]=c.useState(12),M=c.useRef(12),[E,N]=c.useState(null),h=c.useRef(new Map),k=c.useRef([]),C=c.useRef(null);c.useEffect(()=>{if(!(!y||!b||!m.current||n.current))try{const{Map:D,AdvancedMarkerElement:Z}=b;n.current=new D(m.current,{center:e,zoom:12,mapId:"BLOODATHOME_PROVIDER_MAP",disableDefaultUI:!1,zoomControl:!0,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!0});const q=document.createElement("div");q.innerHTML=`
                <div class="relative flex items-center justify-center">
                    <div class="absolute w-8 h-8 bg-blue-500/30 rounded-full animate-ping"></div>
                    <div class="absolute w-6 h-6 bg-blue-500/20 rounded-full"></div>
                    <div class="relative w-3 h-3 bg-blue-600 rounded-full border-2 border-white shadow-lg"></div>
                </div>
            `,u.current=new Z({map:n.current,position:e,content:q,title:"Your Location"}),w.current=new google.maps.InfoWindow({disableAutoPan:!0});const g=document.createElement("style");g.textContent=`
                .gm-ui-hover-effect { display: none !important; }
                .gm-style-iw-chr { display: none !important; }
            `,document.head.appendChild(g),n.current.addListener("zoom_changed",()=>{const F=n.current?.getZoom();F!==void 0&&(M.current=F,A(F),z())}),n.current.addListener("click",()=>{z()}),google.maps.event.addListenerOnce(n.current,"idle",()=>{P(!0)}),_(!1)}catch(D){console.error("Error initializing map:",D),_(!0)}},[y,b,e]);const z=c.useCallback(()=>{E&&(h.current.forEach(D=>{D.map=null}),h.current.clear(),k.current.forEach(D=>{D.setMap(null)}),k.current=[],N(null))},[E]);return c.useEffect(()=>{if(!n.current||!T||s.length===0)return;const D=new google.maps.LatLngBounds;D.extend(e),s.filter(q=>q.latitude&&q.longitude).forEach(q=>{D.extend({lat:q.latitude,lng:q.longitude})}),n.current.fitBounds(D,{padding:60})},[s,e,T]),c.useEffect(()=>{if(!n.current||!b||!y)return;const{AdvancedMarkerElement:D}=b;p.current.forEach(x=>{x.map=null}),p.current.clear(),h.current.forEach(x=>{x.map=null}),h.current.clear(),k.current.forEach(x=>{x.setMap(null)}),k.current=[],N(null);const Z=(x,B)=>{if(B)return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>`;const U=x?.toLowerCase()||"";return U==="clinic"?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M12 8v8"/>
                    <path d="M8 12h8"/>
                </svg>`:U==="laboratory"?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 3h6"/>
                    <path d="M10 9V3h4v6"/>
                    <path d="m8 16 1.5-5h5l1.5 5"/>
                    <path d="M6 21h12a2 2 0 0 0 1.66-3.11l-4.37-6.56a1 1 0 0 1-.16-.54V3H8.87v7.79a1 1 0 0 1-.16.54l-4.37 6.56A2 2 0 0 0 6 21z"/>
                </svg>`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m18 2 4 4"/>
                <path d="m17 7 3-3"/>
                <path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/>
                <path d="m9 11 4 4"/>
                <path d="m5 19-3 3"/>
                <path d="m14 4 6 6"/>
            </svg>`},q=(x,B,U=!1)=>{const Y=r?.id===x.id,ne=x.services_matched===x.services_total&&(x.services_total??0)>0,J=x.total_price??0,ie=x.average_rating??0,ee=Y?"bg-blue-600 border-blue-800":ne?"bg-emerald-500 border-emerald-700":"bg-orange-500 border-orange-700",te=document.createElement("div");te.className="provider-marker",te.innerHTML=`
                <style>
                    .provider-marker .marker-icon {
                        animation: marker-pulse 2s ease-in-out infinite;
                    }
                    .provider-marker:hover .marker-icon {
                        animation-play-state: paused;
                    }
                    @keyframes marker-pulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.08); }
                    }
                    .provider-marker .marker-label {
                        background: rgba(255, 255, 255, 0.95);
                    }
                    .provider-marker .marker-label-price {
                        color: #111827;
                    }
                    @media (prefers-color-scheme: dark) {
                        .provider-marker .marker-label {
                            background: rgba(17, 24, 39, 0.95);
                        }
                        .provider-marker .marker-label-price {
                            color: #f3f4f6;
                        }
                    }
                </style>
                <div class="flex flex-col items-center cursor-pointer">
                    <div class="marker-icon ${ee} border-2 rounded-full p-2 shadow-lg transition-transform hover:scale-110 ${Y?"scale-110":""}">
                        ${Z(x.type?.name,Y)}
                    </div>
                    <div class="marker-label backdrop-blur-sm rounded px-1.5 py-0.5 shadow-md mt-1 text-center min-w-[50px]">
                        <div class="marker-label-price text-xs font-bold">£${J.toFixed(0)}</div>
                        <div class="text-[10px] text-yellow-600 flex items-center justify-center gap-0.5">
                            <span>★</span>
                            <span>${ie.toFixed(1)}</span>
                        </div>
                    </div>
                </div>
            `;const ae=new D({map:n.current,position:B,content:te,title:x.user?.full_name||x.provider_name||"Provider"});return Y?(te.style.cursor="default",ae):(te.addEventListener("mouseenter",()=>{if(C.current&&(clearTimeout(C.current),C.current=null),!w.current||!n.current)return;const le=x.services_matched!==void 0&&x.services_total!==void 0?`${x.services_matched} of ${x.services_total} services`:"",me=ne?"text-emerald-600":"text-orange-600",Q=document.documentElement.classList.contains("dark"),de=Q?"#1f2937":"#ffffff",ce=Q?"#f3f4f6":"#111827",ue=Q?"#d1d5db":"#6b7280",L=`
                    <style>
                        .gm-style-iw-d { background: ${de} !important; overflow: hidden !important; }
                        .gm-style-iw-c { background: ${de} !important; }
                        .gm-style-iw-tc::after { background: ${de} !important; }
                    </style>
                    <div class="p-3 max-w-[220px]">
                        <h3 class="font-semibold text-sm mb-2" style="color: ${ce}">
                            ${x.user?.full_name||x.provider_name||"Unknown Provider"}
                        </h3>
                        <div class="space-y-1 text-xs">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-1">
                                    <span class="text-yellow-500">★</span>
                                    <span class="font-medium" style="color: ${ce}">${ie.toFixed(1)}</span>
                                    <span style="color: #9ca3af">(${x.total_reviews??0})</span>
                                </div>
                                <span class="font-bold" style="color: ${ce}">£${J.toFixed(2)}</span>
                            </div>
                            ${x.distance_km!==void 0?`
                                <div style="color: ${ue}">${x.distance_km.toFixed(1)} km away</div>
                            `:""}
                            ${le?`<div class="${me} font-medium">${le}</div>`:""}
                        </div>
                    </div>
                `;w.current.setContent(L),w.current.open({map:n.current,anchor:ae})}),te.addEventListener("mouseleave",()=>{C.current=setTimeout(()=>{w.current?.close(),C.current=null},100)}),te.addEventListener("click",()=>{w.current?.close(),i(x)}),ae)},g=x=>{if(!n.current)return;h.current.forEach(J=>{J.map=null}),h.current.clear(),k.current.forEach(J=>{J.setMap(null)}),k.current=[];const B=p.current.get(x.id);B&&(B.map=null);const U=M.current,Y=U>=16?.03:U>=14?.05:U>=12?.1:.2,ne=Ft(x.center,x.items.length,Y);x.items.forEach((J,ie)=>{const ee=ne[ie],te=q(J,ee,!0);te&&h.current.set(J.id,te);const ae=new google.maps.Polyline({path:[x.center,ee],strokeColor:"#9ca3af",strokeWeight:1,strokeOpacity:.6,map:n.current});k.current.push(ae)}),N(x.id)},H=s.filter(x=>x.latitude&&x.longitude&&x.id!==r?.id).map(x=>({id:x.id,latitude:x.latitude,longitude:x.longitude,...x})),G=It(o);if(At(H,G).forEach(x=>{if(x.isCluster){const B=document.createElement("div");B.className="cluster-marker",B.innerHTML=`
                    <style>
                        .cluster-marker .cluster-icon {
                            animation: cluster-pulse 2s ease-in-out infinite;
                        }
                        .cluster-marker:hover .cluster-icon {
                            animation-play-state: paused;
                            transform: scale(1.1);
                        }
                        @keyframes cluster-pulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                        }
                    </style>
                    <div class="flex flex-col items-center cursor-pointer">
                        <div class="cluster-icon bg-white/95 border-2 border-gray-300 rounded-full w-11 h-11 flex flex-col items-center justify-center shadow-lg backdrop-blur-sm">
                            <span class="text-gray-800 font-bold text-sm leading-none">${x.items.length}</span>
                            <svg width="14" height="10" viewBox="0 0 24 16" fill="none" stroke="#6b7280" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="mt-0.5">
                                <path d="M16 14v-1a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v1"/>
                                <circle cx="10" cy="4" r="3"/>
                                <path d="M20 14v-1a3 3 0 0 0-2.1-2.9"/>
                                <path d="M15.5 1.1a3 3 0 0 1 0 5.8"/>
                            </svg>
                        </div>
                    </div>
                `;const U=new D({map:n.current,position:x.center,content:B,title:`${x.items.length} providers`});B.addEventListener("click",()=>{w.current?.close(),g(x)}),p.current.set(x.id,U)}else{const B=x.items[0],U={lat:B.latitude,lng:B.longitude},Y=q(B,U);Y&&p.current.set(B.id,Y)}}),r&&r.latitude&&r.longitude){const x={lat:r.latitude,lng:r.longitude},B=q(r,x);B&&p.current.set(r.id,B)}},[s,r,b,y,i,o]),a||R||!d?t.jsxs("div",{className:re("relative w-full h-[450px] bg-muted rounded-2xl flex flex-col items-center justify-center p-6",l),children:[t.jsx(Ce,{className:"w-10 h-10 text-muted-foreground mb-2"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:d?a?.message||"Map unavailable":"Google Maps API key not configured"})]}):y?t.jsxs("div",{className:re("relative w-full h-[450px] rounded-2xl overflow-hidden border border-border",l),children:[t.jsx("div",{ref:m,className:"absolute inset-0"}),t.jsx("div",{className:"absolute top-4 left-4 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 shadow-lg z-10",children:t.jsxs("p",{className:"text-sm text-gray-900 dark:text-gray-100 font-medium",children:[s.length," provider",s.length!==1?"s":""," nearby"]})})]}):t.jsx("div",{className:re("relative w-full h-[450px] bg-muted rounded-2xl flex items-center justify-center",l),children:t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx(De,{className:"w-8 h-8 text-primary animate-spin"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading map..."})]})})}function Ms({providers:s,userLocation:e,selectedProvider:r,onProviderClick:i,mapboxToken:d,className:l}){const y=c.useRef(null),a=c.useRef(null),b=c.useRef(null),m=c.useRef(new Map),n=c.useRef(null),[u,p]=c.useState(!1),[w,R]=c.useState(!0),[_,T]=c.useState(12),P=c.useRef(12),[o,A]=c.useState(null),M=c.useRef(new Map),E=c.useRef([]);c.useEffect(()=>{if(!(!d||!y.current||a.current)){try{Te.accessToken=d,a.current=new Te.Map({container:y.current,style:"mapbox://styles/mapbox/streets-v12",center:[e.lng,e.lat],zoom:12}),a.current.addControl(new Te.NavigationControl);const h=document.createElement("div");h.innerHTML=`
                <div class="relative flex items-center justify-center">
                    <div class="absolute w-8 h-8 bg-blue-500/30 rounded-full animate-ping"></div>
                    <div class="absolute w-6 h-6 bg-blue-500/20 rounded-full"></div>
                    <div class="relative w-3 h-3 bg-blue-600 rounded-full border-2 border-white shadow-lg"></div>
                </div>
            `,b.current=new Te.Marker({element:h}).setLngLat([e.lng,e.lat]).addTo(a.current),n.current=new Te.Popup({closeButton:!1,closeOnClick:!1,offset:25}),a.current.on("load",()=>{R(!1)}),a.current.on("zoom",()=>{const k=a.current?.getZoom();k!==void 0&&(P.current=k,T(k))}),a.current.on("click",k=>{k.originalEvent.defaultPrevented||N()}),p(!1)}catch(h){console.error("Error initializing Mapbox:",h),p(!0),R(!1)}return()=>{a.current&&(a.current.remove(),a.current=null)}}},[d,e]);const N=c.useCallback(()=>{!o||!a.current||(M.current.forEach(h=>{h.remove()}),M.current.clear(),E.current.forEach(h=>{a.current&&a.current.getLayer(h)&&a.current.removeLayer(h),a.current&&a.current.getSource(h)&&a.current.removeSource(h)}),E.current=[],A(null))},[o]);return c.useEffect(()=>{if(!a.current||w||s.length===0)return;const h=new Te.LngLatBounds;h.extend([e.lng,e.lat]),s.filter(C=>C.latitude&&C.longitude).forEach(C=>{h.extend([C.longitude,C.latitude])}),a.current.fitBounds(h,{padding:60})},[s,e,w]),c.useEffect(()=>{if(!a.current||!d||w)return;m.current.forEach(g=>{g.remove()}),m.current.clear(),M.current.forEach(g=>{g.remove()}),M.current.clear(),E.current.forEach(g=>{a.current&&a.current.getLayer(g)&&a.current.removeLayer(g),a.current&&a.current.getSource(g)&&a.current.removeSource(g)}),E.current=[],A(null);const h=(g,F)=>{if(F)return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>`;const H=g?.toLowerCase()||"";return H==="clinic"?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M12 8v8"/>
                    <path d="M8 12h8"/>
                </svg>`:H==="laboratory"?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 3h6"/>
                    <path d="M10 9V3h4v6"/>
                    <path d="m8 16 1.5-5h5l1.5 5"/>
                    <path d="M6 21h12a2 2 0 0 0 1.66-3.11l-4.37-6.56a1 1 0 0 1-.16-.54V3H8.87v7.79a1 1 0 0 1-.16.54l-4.37 6.56A2 2 0 0 0 6 21z"/>
                </svg>`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m18 2 4 4"/>
                <path d="m17 7 3-3"/>
                <path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/>
                <path d="m9 11 4 4"/>
                <path d="m5 19-3 3"/>
                <path d="m14 4 6 6"/>
            </svg>`},k=(g,F,H=!1)=>{const G=r?.id===g.id,j=g.services_matched===g.services_total&&(g.services_total??0)>0,x=g.total_price??0,B=g.average_rating??0,U=G?"bg-blue-600 border-blue-800":j?"bg-emerald-500 border-emerald-700":"bg-orange-500 border-orange-700",Y=document.createElement("div");Y.className="provider-marker-mapbox",Y.innerHTML=`
                <style>
                    .provider-marker-mapbox .marker-icon {
                        animation: marker-pulse-mapbox 2s ease-in-out infinite;
                    }
                    .provider-marker-mapbox:hover .marker-icon {
                        animation-play-state: paused;
                    }
                    @keyframes marker-pulse-mapbox {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.08); }
                    }
                    .provider-marker-mapbox .marker-label {
                        background: rgba(255, 255, 255, 0.95);
                    }
                    .provider-marker-mapbox .marker-label-price {
                        color: #111827;
                    }
                    @media (prefers-color-scheme: dark) {
                        .provider-marker-mapbox .marker-label {
                            background: rgba(17, 24, 39, 0.95);
                        }
                        .provider-marker-mapbox .marker-label-price {
                            color: #f3f4f6;
                        }
                    }
                </style>
                <div class="flex flex-col items-center cursor-pointer">
                    <div class="marker-icon ${U} border-2 rounded-full p-2 shadow-lg transition-transform hover:scale-110 ${G?"scale-110":""}">
                        ${h(g.type?.name,G)}
                    </div>
                    <div class="marker-label backdrop-blur-sm rounded px-1.5 py-0.5 shadow-md mt-1 text-center min-w-[50px]">
                        <div class="marker-label-price text-xs font-bold">£${x.toFixed(0)}</div>
                        <div class="text-[10px] text-yellow-600 flex items-center justify-center gap-0.5">
                            <span>★</span>
                            <span>${B.toFixed(1)}</span>
                        </div>
                    </div>
                </div>
            `;const ne=new Te.Marker({element:Y}).setLngLat(F).addTo(a.current);if(G)return Y.style.cursor="default",ne;const J=g.services_matched!==void 0&&g.services_total!==void 0?`${g.services_matched} of ${g.services_total} services`:"",ie=j?"text-emerald-600":"text-orange-600";return Y.addEventListener("mouseenter",()=>{if(!n.current||!a.current)return;const ee=document.createElement("div");ee.className="p-3 max-w-[220px] mapbox-popup-content",ee.innerHTML=`
                    <style>
                        .mapbox-popup-content { color: #111827; }
                        .mapbox-popup-secondary { color: #6b7280; }
                        .mapbox-popup-muted { color: #9ca3af; }
                        @media (prefers-color-scheme: dark) {
                            .mapbox-popup-content { color: #f3f4f6; background: #1f2937; }
                            .mapbox-popup-secondary { color: #d1d5db; }
                            .mapbox-popup-muted { color: #9ca3af; }
                            .mapboxgl-popup-content { background: #1f2937 !important; }
                            .mapboxgl-popup-tip { border-top-color: #1f2937 !important; }
                        }
                    </style>
                    <h3 class="font-semibold text-sm mb-2">
                        ${g.user?.full_name||g.provider_name||"Unknown Provider"}
                    </h3>
                    <div class="space-y-1 text-xs">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1">
                                <span class="text-yellow-500">★</span>
                                <span class="font-medium">${B.toFixed(1)}</span>
                                <span class="mapbox-popup-muted">(${g.total_reviews??0})</span>
                            </div>
                            <span class="font-bold">£${x.toFixed(2)}</span>
                        </div>
                        ${g.distance_km!==void 0?`
                            <div class="mapbox-popup-secondary">${g.distance_km.toFixed(1)} km away</div>
                        `:""}
                        ${J?`<div class="${ie} font-medium">${J}</div>`:""}
                    </div>
                `,n.current.setLngLat(F).setDOMContent(ee).addTo(a.current)}),Y.addEventListener("mouseleave",()=>{setTimeout(()=>{n.current?.remove()},100)}),Y.addEventListener("click",ee=>{ee.stopPropagation(),n.current?.remove(),i(g)}),ne},C=g=>{if(!a.current)return;M.current.forEach(x=>{x.remove()}),M.current.clear(),E.current.forEach(x=>{a.current&&a.current.getLayer(x)&&a.current.removeLayer(x),a.current&&a.current.getSource(x)&&a.current.removeSource(x)}),E.current=[];const F=m.current.get(g.id);F&&F.remove();const H=P.current,G=H>=16?.03:H>=14?.05:H>=12?.1:.2,j=Ft(g.center,g.items.length,G);g.items.forEach((x,B)=>{const U=j[B],Y=[U.lng,U.lat],ne=k(x,Y,!0);ne&&M.current.set(x.id,ne);const J=`spiderfy-line-${g.id}-${B}`,ie=J;a.current.addSource(ie,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[g.center.lng,g.center.lat],[U.lng,U.lat]]}}}),a.current.addLayer({id:J,type:"line",source:ie,paint:{"line-color":"#9ca3af","line-width":1,"line-opacity":.6}}),E.current.push(J)}),A(g.id)},D=s.filter(g=>g.latitude&&g.longitude&&g.id!==r?.id).map(g=>({id:g.id,latitude:g.latitude,longitude:g.longitude,...g})),Z=It(_);if(At(D,Z).forEach(g=>{if(g.isCluster){const F=document.createElement("div");F.className="cluster-marker-mapbox",F.innerHTML=`
                    <style>
                        .cluster-marker-mapbox .cluster-icon {
                            animation: cluster-pulse-mapbox 2s ease-in-out infinite;
                        }
                        .cluster-marker-mapbox:hover .cluster-icon {
                            animation-play-state: paused;
                            transform: scale(1.1);
                        }
                        @keyframes cluster-pulse-mapbox {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                        }
                    </style>
                    <div class="flex flex-col items-center cursor-pointer">
                        <div class="cluster-icon bg-white/95 border-2 border-gray-300 rounded-full w-11 h-11 flex flex-col items-center justify-center shadow-lg backdrop-blur-sm">
                            <span class="text-gray-800 font-bold text-sm leading-none">${g.items.length}</span>
                            <svg width="14" height="10" viewBox="0 0 24 16" fill="none" stroke="#6b7280" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="mt-0.5">
                                <path d="M16 14v-1a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v1"/>
                                <circle cx="10" cy="4" r="3"/>
                                <path d="M20 14v-1a3 3 0 0 0-2.1-2.9"/>
                                <path d="M15.5 1.1a3 3 0 0 1 0 5.8"/>
                            </svg>
                        </div>
                    </div>
                `;const H=new Te.Marker({element:F}).setLngLat([g.center.lng,g.center.lat]).addTo(a.current);F.addEventListener("click",G=>{G.stopPropagation(),n.current?.remove(),C(g)}),m.current.set(g.id,H)}else{const F=g.items[0],H=[F.longitude,F.latitude],G=k(F,H);G&&m.current.set(F.id,G)}}),r&&r.latitude&&r.longitude){const g=[r.longitude,r.latitude],F=k(r,g);F&&m.current.set(r.id,F)}},[s,r,i,d,_,w]),u||!d?t.jsxs("div",{className:re("relative w-full h-[450px] bg-muted rounded-2xl flex flex-col items-center justify-center p-6",l),children:[t.jsx(Ce,{className:"w-10 h-10 text-muted-foreground mb-2"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:d?"Map unavailable":"Mapbox access token not configured"})]}):t.jsxs("div",{className:re("relative w-full h-[450px] rounded-2xl overflow-hidden border border-border",l),children:[t.jsx("div",{ref:y,className:"absolute inset-0"}),w&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-muted/50 backdrop-blur-sm",children:t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx(De,{className:"w-8 h-8 text-primary animate-spin"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading map..."})]})}),t.jsx("div",{className:"absolute top-4 left-4 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 shadow-lg z-10",children:t.jsxs("p",{className:"text-sm text-gray-900 dark:text-gray-100 font-medium",children:[s.length," provider",s.length!==1?"s":""," nearby"]})})]})}function Es(s){const e=be.c(37),{providers:r,selectedProvider:i,onProviderClick:d}=s,[l,y]=c.useState(!1),a=l?r.length:2;let b,m,n,u;if(e[0]!==a||e[1]!==l||e[2]!==d||e[3]!==r||e[4]!==i?.id){const _=r.slice(0,a),T=l?"max-h-[70vh]":"max-h-[200px]";e[9]!==T?(n=re("fixed bottom-0 left-0 right-0 bg-card border-t border-border rounded-t-2xl shadow-2xl z-20 transition-all duration-300 lg:hidden",T),e[9]=T,e[10]=n):n=e[10];let P;e[11]!==l?(P=()=>y(!l),e[11]=l,e[12]=P):P=e[12];const o=l?"Collapse provider list":"Expand provider list";let A;e[13]===Symbol.for("react.memo_cache_sentinel")?(A=t.jsx("div",{className:"w-10 h-1 bg-muted-foreground/30 rounded-full"}),e[13]=A):A=e[13];let M;e[14]!==l||e[15]!==r.length?(M=t.jsx("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:l?t.jsxs(t.Fragment,{children:[t.jsx(Et,{className:"w-3 h-3"}),t.jsx("span",{children:"Collapse"})]}):t.jsxs(t.Fragment,{children:[t.jsx(Mt,{className:"w-3 h-3"}),t.jsxs("span",{children:[r.length," providers nearby"]})]})}),e[14]=l,e[15]=r.length,e[16]=M):M=e[16],e[17]!==P||e[18]!==o||e[19]!==M?(u=t.jsxs("button",{type:"button",onClick:P,className:"w-full py-3 flex flex-col items-center gap-1 cursor-pointer touch-manipulation","aria-label":o,children:[A,M]}),e[17]=P,e[18]=o,e[19]=M,e[20]=u):u=e[20];const E=l?"max-h-[calc(70vh-60px)]":"max-h-[140px]";e[21]!==E?(b=re("overflow-y-auto px-4 pb-4 space-y-2",E),e[21]=E,e[22]=b):b=e[22];let N;e[23]!==d||e[24]!==i?.id?(N=h=>{const k=i?.id===h.id,C=h.services_matched===h.services_total&&(h.services_total??0)>0,z=h.total_price??0;return t.jsx("button",{type:"button",onClick:()=>!k&&d(h),disabled:k,className:re("w-full p-3 rounded-xl border transition-all text-left",k?"border-blue-500 bg-blue-50 dark:bg-blue-950/30 cursor-default":"border-border hover:border-primary/50 cursor-pointer"),children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:re("w-10 h-10 rounded-full flex items-center justify-center shrink-0 text-sm font-semibold",k?"bg-blue-500 text-white":C?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300":"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300"),children:k?t.jsx(_e,{className:"w-5 h-5"}):(h.user?.full_name||h.provider_name||"P").charAt(0)}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-medium text-foreground text-sm truncate",children:h.user?.full_name||h.provider_name||"Unknown"}),t.jsxs(Tt,{variant:"outline",className:re("text-[10px] px-1.5 py-0",C?"border-emerald-500 bg-emerald-50 text-emerald-700 dark:bg-emerald-950 dark:text-emerald-400":"border-orange-500 bg-orange-50 text-orange-700 dark:bg-orange-950 dark:text-orange-400"),children:[h.services_matched,"/",h.services_total]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mt-0.5",children:[t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(st,{className:"w-3 h-3 text-yellow-500 fill-yellow-500"}),h.average_rating?.toFixed(1)]}),h.distance_km!==void 0&&t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(Ce,{className:"w-3 h-3"}),h.distance_km.toFixed(1)," km"]})]})]}),t.jsx("div",{className:"text-right shrink-0",children:t.jsxs("div",{className:"font-bold text-foreground",children:["£",z.toFixed(0)]})})]})},h.id)},e[23]=d,e[24]=i?.id,e[25]=N):N=e[25],m=_.map(N),e[0]=a,e[1]=l,e[2]=d,e[3]=r,e[4]=i?.id,e[5]=b,e[6]=m,e[7]=n,e[8]=u}else b=e[5],m=e[6],n=e[7],u=e[8];let p;e[26]!==l||e[27]!==r.length?(p=!l&&r.length>2&&t.jsxs("button",{type:"button",onClick:()=>y(!0),className:"w-full py-2 text-sm text-primary font-medium",children:["Show ",r.length-2," more providers"]}),e[26]=l,e[27]=r.length,e[28]=p):p=e[28];let w;e[29]!==b||e[30]!==m||e[31]!==p?(w=t.jsxs("div",{className:b,children:[m,p]}),e[29]=b,e[30]=m,e[31]=p,e[32]=w):w=e[32];let R;return e[33]!==n||e[34]!==u||e[35]!==w?(R=t.jsxs("div",{className:n,children:[u,w]}),e[33]=n,e[34]=u,e[35]=w,e[36]=R):R=e[36],R}function Ts({googleMapsKey:s}){const{location:e,selectedDate:r,timeOfDay:i,selectedServices:d,collectionType:l,selectedProvider:y,selectedSlot:a,setSelectedProvider:b,setSelectedSlot:m,setBookedServices:n,setProviderServicePrices:u,setStep:p,goBack:w}=Pe(),{searchProviders:R,getProviderAvailability:_}=Ke(),[T,P]=c.useState([]),[o,A]=c.useState([]),[M,E]=c.useState(!0),[N,h]=c.useState(""),[k,C]=c.useState("match"),[z,D]=c.useState(10),[Z,q]=c.useState(0),[g,F]=c.useState(!1),[H,G]=c.useState(!1),[j,x]=c.useState(null),[B,U]=c.useState([]),[Y,ne]=c.useState(!1),[J,ie]=c.useState("list"),[ee,te]=c.useState(!1),ae=c.useRef(null),le=6;c.useEffect(()=>{if(!e||!r)return;E(!0);const f=setTimeout(async()=>{try{const K=d.map(je=>je.id),W=Ie(r,"yyyy-MM-dd"),fe=await R({lat:e.lat,lng:e.lng,service_ids:K,collection_type:l||void 0,date:W,radius_km:z});P(fe),A(fe)}catch(K){const W=K instanceof Error?K.message:"Failed to load providers";V.error(W),console.error("Error loading providers:",K)}finally{E(!1)}},300);return()=>clearTimeout(f)},[e,r,l,d,z]),c.useEffect(()=>{let f=[...T];if(N.trim()){const K=N.toLowerCase();f=f.filter(W=>(W.user?.full_name||W.name||"").toLowerCase().includes(K)||W.provider_name?.toLowerCase().includes(K)||W.bio?.toLowerCase().includes(K))}Z>0&&(f=f.filter(K=>K.average_rating>=Z)),g&&(f=f.filter(K=>K.services_matched===K.services_total&&K.services_total>0)),f.sort((K,W)=>{switch(k){case"match":const fe=(K.services_matched||0)/(K.services_total||1),je=(W.services_matched||0)/(W.services_total||1);return je!==fe?je-fe:(K.distance_km||0)-(W.distance_km||0);case"distance":return(K.distance_km||0)-(W.distance_km||0);case"rating":return W.average_rating-K.average_rating;case"price_low":return me(K)-me(W);case"price_high":return me(W)-me(K);default:return 0}}),A(f)},[T,N,k,Z,g]),c.useEffect(()=>{te(!1)},[o]);const me=f=>f.total_price!==void 0?f.total_price:!f.provider_services||f.provider_services.length===0?0:f.provider_services.reduce((K,W)=>K+W.base_cost,0),Q=async f=>{if(b(f),m(null),f.matched_services&&f.matched_services.length>0){const K=f.matched_services.map(fe=>({id:fe.id,service_name:fe.name,service_code:"",is_active:!0,category:{id:0,name:""}}));n(K);const W={};f.matched_services.forEach(fe=>{W[fe.id]=fe.price}),u(W)}else n(d);r&&await de(f.id,r),setTimeout(()=>{ae.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},de=async(f,K)=>{ne(!0);try{const W=Ie(K,"yyyy-MM-dd"),fe=await _(f,W);U(fe)}catch(W){console.error("Error loading availability:",W),V.error("Failed to load available time slots"),U([])}finally{ne(!1)}};c.useEffect(()=>{y&&r&&B.length===0&&!Y&&de(y.id,r)},[]);const ce=f=>{m(f)},ue=()=>{if(!y){V.error("Please select a provider");return}if(!a){V.error("Please select a time slot");return}p("patient")},S=o.length>=le*2,L=S&&!ee?o.slice(0,le):o,X=o.length-le;return M?t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx(it,{label:"Back to Location & Date",onClick:w}),t.jsx("h1",{className:"text-2xl font-semibold text-foreground mb-2",children:"Select Provider"}),t.jsxs("p",{className:"text-muted-foreground",children:["Found ",o.length," provider",o.length!==1?"s":""," in your area"]})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(St,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),t.jsx(ge,{type:"text",placeholder:"Search providers...",value:N,onChange:f=>h(f.target.value),className:"pl-10"})]}),t.jsxs("div",{className:"flex gap-1 bg-muted rounded-lg p-1",children:[t.jsx(se,{type:"button",variant:J==="list"?"default":"ghost",size:"sm",onClick:()=>ie("list"),className:"px-3","aria-label":"List view",children:t.jsx(fs,{className:"w-4 h-4"})}),t.jsx(se,{type:"button",variant:J==="map"?"default":"ghost",size:"sm",onClick:()=>ie("map"),className:"px-3","aria-label":"Map view",children:t.jsx(Pt,{className:"w-4 h-4"})})]}),t.jsx(se,{type:"button",variant:"outline",onClick:()=>G(!H),className:"px-4","aria-label":H?"Hide filters":"Show filters","aria-expanded":H,children:t.jsx(gs,{className:"w-4 h-4"})})]}),H&&t.jsxs("div",{className:"space-y-3 p-4 bg-accent/30 rounded-xl border border-border",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-xs font-medium text-foreground",children:"Sort By"}),t.jsxs(qe,{value:k,onValueChange:f=>C(f),children:[t.jsx(Ye,{className:"h-10",children:t.jsx(Xe,{})}),t.jsxs(We,{children:[t.jsx(ve,{value:"match",children:"Best Match"}),t.jsx(ve,{value:"distance",children:"Distance"}),t.jsx(ve,{value:"rating",children:"Rating"}),t.jsx(ve,{value:"price_low",children:"Price: Low to High"}),t.jsx(ve,{value:"price_high",children:"Price: High to Low"})]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-xs font-medium text-foreground",children:"Max Distance (km)"}),t.jsxs(qe,{value:z.toString(),onValueChange:f=>D(Number(f)),children:[t.jsx(Ye,{className:"h-10",children:t.jsx(Xe,{})}),t.jsxs(We,{children:[t.jsx(ve,{value:"5",children:"5 km"}),t.jsx(ve,{value:"10",children:"10 km"}),t.jsx(ve,{value:"20",children:"20 km"}),t.jsx(ve,{value:"50",children:"50 km"})]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-xs font-medium text-foreground",children:"Min Rating"}),t.jsxs(qe,{value:Z.toString(),onValueChange:f=>q(Number(f)),children:[t.jsx(Ye,{className:"h-10",children:t.jsx(Xe,{})}),t.jsxs(We,{children:[t.jsx(ve,{value:"0",children:"All Ratings"}),t.jsx(ve,{value:"3",children:"3+ Stars"}),t.jsx(ve,{value:"4",children:"4+ Stars"}),t.jsx(ve,{value:"4.5",children:"4.5+ Stars"})]})]})]})]}),t.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[t.jsx($e,{id:"fullMatchOnly",checked:g,onCheckedChange:f=>F(f)}),t.jsx("label",{htmlFor:"fullMatchOnly",className:"text-sm text-foreground cursor-pointer",children:"Only show providers with all selected services"})]})]})]}),o.length===0?t.jsxs("div",{className:"text-center py-12 bg-card border border-border rounded-xl",children:[t.jsx(Ce,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"No providers found"}),t.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:T.length===0?`No providers available within ${z} km`:"Try adjusting your filters or increasing the search radius"}),t.jsxs("div",{className:"flex gap-2 justify-center",children:[z<25&&t.jsx(se,{type:"button",variant:"outline",onClick:()=>D(25),children:"Expand to 25 km"}),g&&t.jsx(se,{type:"button",variant:"outline",onClick:()=>F(!1),children:"Show Partial Matches"}),t.jsx(se,{type:"button",variant:"outline",onClick:w,children:"Change Location"})]})]}):J==="map"?t.jsxs(t.Fragment,{children:[t.jsx(Cs,{providers:o,userLocation:e,selectedProvider:y,onProviderClick:f=>x(f)}),t.jsx(Es,{providers:o,selectedProvider:y,onProviderClick:f=>x(f)})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"space-y-3",children:L.map(f=>{const K=y?.id===f.id,W=me(f);return t.jsx("div",{className:re("p-4 rounded-xl border-2 transition-all cursor-pointer",K?"border-primary bg-primary/5":"border-border hover:border-primary/50"),onClick:()=>Q(f),children:t.jsxs("div",{className:"flex items-start gap-4",children:[f.show_image_in_search&&f.user?.profile_image?t.jsx("img",{src:f.user.profile_image,alt:f.user?.full_name||f.name||"Provider",className:"w-16 h-16 rounded-full object-cover shrink-0"}):t.jsx("div",{className:"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx("span",{className:"text-xl font-semibold text-primary",children:(f.user?.full_name||f.name||"P").charAt(0)})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("h3",{className:"font-semibold text-foreground",children:f.user?.full_name||f.name||"Unknown Provider"}),f.services_matched!==void 0&&f.services_total!==void 0&&t.jsxs(Tt,{variant:"outline",className:re("text-xs",f.services_matched===f.services_total?"border-emerald-500 bg-emerald-50 text-emerald-700 dark:bg-emerald-950 dark:text-emerald-400":"border-orange-500 bg-orange-50 text-orange-700 dark:bg-orange-950 dark:text-orange-400"),children:[f.services_matched," of ",f.services_total," ","services"]})]}),t.jsx("p",{className:"text-sm text-muted-foreground",children:f.type.name})]}),t.jsxs("div",{className:"text-right shrink-0",children:[t.jsxs("div",{className:"text-lg font-bold text-primary",children:["£",W.toFixed(2)]}),t.jsx("div",{className:"text-xs text-muted-foreground",children:f.services_matched!==void 0&&f.services_matched<(f.services_total||0)?"partial":"total"})]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm text-muted-foreground mb-2",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(st,{className:"w-4 h-4 text-yellow-500 fill-yellow-500"}),t.jsx("span",{className:"font-medium text-foreground",children:f.average_rating.toFixed(1)}),t.jsxs("span",{children:["(",f.total_reviews,")"]})]}),f.distance_km!==void 0&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ce,{className:"w-4 h-4"}),t.jsxs("span",{children:[f.distance_km.toFixed(1)," km away"]})]}),f.experience_years&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(bt,{className:"w-4 h-4"}),t.jsxs("span",{children:[f.experience_years,"+ years"]})]})]}),f.bio&&t.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mb-2",children:f.bio}),t.jsx("button",{type:"button",onClick:fe=>{fe.stopPropagation(),x(f)},className:"text-sm text-primary hover:underline",children:"View Details"})]})]})},f.id)})}),S&&!ee&&t.jsx("div",{className:"flex justify-center pt-2",children:t.jsxs(se,{type:"button",variant:"outline",onClick:()=>te(!0),className:"w-full sm:w-auto",children:["Show ",X," more provider",X!==1?"s":""]})})]}),y&&t.jsxs("div",{ref:ae,className:"bg-card border border-border rounded-xl p-6 space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(He,{className:"w-5 h-5 text-primary"}),t.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Select Time Slot"})]}),Y?t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary"})}):B.length===0?t.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[t.jsx("p",{children:"No available time slots for the selected date."}),t.jsx("p",{className:"text-sm mt-2",children:"Please try a different provider or date."})]}):t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3",children:B.map(f=>{const K=a?.time===f.time,W=!f.available;return t.jsx("button",{type:"button",onClick:()=>ce(f),disabled:W,className:re("p-3 rounded-lg border-2 transition-all text-sm font-medium",K&&"border-primary bg-primary/10 text-primary",!K&&!W&&"border-border hover:border-primary/50 text-foreground",W&&"border-border bg-muted text-muted-foreground opacity-50 cursor-not-allowed"),children:f.time},f.time)})})]}),t.jsx("div",{className:"flex flex-col sm:flex-row gap-3 pt-4",children:t.jsx(se,{onClick:ue,disabled:!y||!a,className:"flex-1 py-6 text-base",size:"lg",children:"Continue to Patient Details"})}),t.jsx(tt,{open:!!j,onOpenChange:()=>x(null),children:t.jsx(et,{className:"max-w-2xl max-h-[90vh] flex flex-col p-0",children:j&&t.jsxs(t.Fragment,{children:[t.jsx(Je,{className:"px-6 py-4 border-b border-border shrink-0",children:t.jsx(Qe,{children:j.user?.full_name||j.name||"Provider Details"})}),t.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-4 space-y-4",children:[t.jsxs("div",{className:"flex items-start gap-4",children:[j.user?.profile_image?t.jsx("img",{src:j.user.profile_image,alt:j.user?.full_name||j.name||"Provider",className:"w-24 h-24 rounded-full object-cover shrink-0"}):t.jsx("div",{className:"w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx("span",{className:"text-3xl font-semibold text-primary",children:(j.user?.full_name||j.name||"P").charAt(0)})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:j.type.name}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(st,{className:"w-4 h-4 text-yellow-500 fill-yellow-500"}),t.jsx("span",{className:"font-medium",children:j.average_rating.toFixed(1)}),t.jsxs("span",{className:"text-muted-foreground",children:["(",j.total_reviews," reviews)"]})]}),j.experience_years&&t.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[t.jsx(bt,{className:"w-4 h-4"}),t.jsxs("span",{children:[j.experience_years,"+ years experience"]})]})]})]})]}),j.bio&&t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-foreground mb-2",children:"About"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:j.bio})]}),(j.matched_services||j.unmatched_services)&&t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-foreground mb-2",children:"Requested Services"}),t.jsxs("div",{className:"space-y-2",children:[j.matched_services?.map(f=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-800",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(_e,{className:"w-4 h-4 text-green-600 dark:text-green-400"}),t.jsx("span",{className:"text-sm text-foreground",children:f.name})]}),t.jsxs("span",{className:"text-sm font-medium text-foreground",children:["£",f.price.toFixed(2)]})]},f.id)),j.unmatched_services?.map(f=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900/20 rounded-lg border border-gray-200 dark:border-gray-800",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ge,{className:"w-4 h-4 text-gray-400"}),t.jsx("span",{className:"text-sm text-muted-foreground",children:f.name})]}),t.jsx("span",{className:"text-sm text-muted-foreground",children:"Not available"})]},f.id))]})]}),j.provider_services&&j.provider_services.length>0&&!j.matched_services&&t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-foreground mb-2",children:"Services & Pricing"}),t.jsx("div",{className:"space-y-2",children:j.provider_services.map(f=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-accent/30 rounded-lg",children:[t.jsx("span",{className:"text-sm text-foreground",children:f.service.service_name}),t.jsxs("span",{className:"text-sm font-medium text-foreground",children:["£",f.base_cost.toFixed(2)]})]},f.id))})]})]}),t.jsx("div",{className:"px-6 py-4 border-t border-border bg-background shrink-0",children:t.jsxs("div",{className:"flex items-center justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Total"}),t.jsxs("p",{className:"text-xl font-bold text-primary",children:["£",j.total_price?.toFixed(2)||me(j).toFixed(2)]})]}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(se,{variant:"outline",onClick:()=>x(null),children:"Cancel"}),t.jsx(se,{onClick:()=>{Q(j),x(null)},disabled:j.matched_services&&j.matched_services.length===0,children:j.matched_services&&j.matched_services.length<(j.services_total||0)?`Select (${j.matched_services.length} services)`:"Select Provider"})]})]})})]})})})]})}function Ls(s){const e=be.c(64),{userData:r,isAuthenticated:i,userDependents:d}=s;let l;e[0]!==d?(l=d===void 0?[]:d,e[0]=d,e[1]=l):l=e[1];const y=l,{patientDetails:a,isNhsTest:b,setPatientDetails:m,setStep:n,goBack:u}=Pe(),[p,w]=c.useState(!i),[,R]=c.useState(!1),[_,T]=c.useState(null);let P;e[2]===Symbol.for("react.memo_cache_sentinel")?(P={firstName:"",lastName:"",email:"",phone:"",dateOfBirth:"",nhsNumber:"",isUnder16:!1,guardianName:"",guardianConfirmed:!1,notes:"",isGuest:!1},e[2]=P):P=e[2];const[o,A]=c.useState(P);let M,E;e[3]!==a||e[4]!==r?(M=()=>{if(a)A(a);else if(r){const[L,...X]=r.name.split(" ");A(f=>({...f,firstName:L||"",lastName:X.join(" ")||"",email:r.email||"",phone:r.phone||""}))}},E=[a,r],e[3]=a,e[4]=r,e[5]=M,e[6]=E):(M=e[5],E=e[6]),c.useEffect(M,E);const N=Os,h=N(o.dateOfBirth);let k;e[7]===Symbol.for("react.memo_cache_sentinel")?(k=(L,X)=>{if(L==="dateOfBirth"&&typeof X=="string"){const f=N(X);A(K=>({...K,dateOfBirth:X,isUnder16:f,guardianName:f?K.guardianName:"",guardianConfirmed:f?K.guardianConfirmed:!1}))}else A(f=>({...f,[L]:X}))},e[7]=k):k=e[7];const C=k,z=Bs,D=Rs,Z=$s,q=Is;let g;e[8]===Symbol.for("react.memo_cache_sentinel")?(g=()=>{R(!0),w(!1),A(Fs)},e[8]=g):g=e[8];const F=g;let H;e[9]!==r||e[10]!==y?(H=L=>{if(T(L),L===null){if(r){const[X,...f]=r.name.split(" ");A({firstName:X||"",lastName:f.join(" ")||"",email:r.email||"",phone:r.phone||"",dateOfBirth:"",nhsNumber:"",isUnder16:!1,guardianName:"",guardianConfirmed:!1,notes:"",isGuest:!1,dependentId:null})}}else{const X=y.find(f=>f.id===L);X&&A({firstName:X.first_name,lastName:X.last_name,email:r?.email||"",phone:r?.phone||"",dateOfBirth:X.date_of_birth,nhsNumber:X.nhs_number||"",isUnder16:N(X.date_of_birth),guardianName:"",guardianConfirmed:!1,notes:"",isGuest:!1,dependentId:X.id})}},e[9]=r,e[10]=y,e[11]=H):H=e[11];const G=H;let j;e[12]!==o||e[13]!==b||e[14]!==m||e[15]!==n?(j=()=>{if(!o.firstName.trim()){V.error("Please enter first name");return}if(!o.lastName.trim()){V.error("Please enter last name");return}if(!z(o.email)){V.error("Please enter a valid email address");return}if(!D(o.phone)){V.error("Please enter a valid UK phone number");return}if(!q(o.dateOfBirth)){V.error("Please enter a valid date of birth");return}if(b&&!Z(o.nhsNumber||"")){V.error("Please enter a valid 10-digit NHS number");return}if(o.isUnder16){if(!o.guardianName?.trim()){V.error("Please enter guardian name");return}if(!o.guardianConfirmed){V.error("Please confirm parental responsibility");return}}m(o),n("payment")},e[12]=o,e[13]=b,e[14]=m,e[15]=n,e[16]=j):j=e[16];const x=j;let B;e[17]!==o.dateOfBirth||e[18]!==o.email||e[19]!==o.firstName||e[20]!==o.lastName||e[21]!==o.phone?(B=o.firstName.trim()&&o.lastName.trim()&&z(o.email)&&D(o.phone)&&q(o.dateOfBirth),e[17]=o.dateOfBirth,e[18]=o.email,e[19]=o.firstName,e[20]=o.lastName,e[21]=o.phone,e[22]=B):B=e[22];const U=B;let Y;e[23]!==o.nhsNumber||e[24]!==b?(Y=!b||Z(o.nhsNumber||""),e[23]=o.nhsNumber,e[24]=b,e[25]=Y):Y=e[25];const ne=Y;let J;e[26]!==o.guardianConfirmed||e[27]!==o.guardianName||e[28]!==o.isUnder16?(J=!o.isUnder16||o.guardianName?.trim()&&o.guardianConfirmed,e[26]=o.guardianConfirmed,e[27]=o.guardianName,e[28]=o.isUnder16,e[29]=J):J=e[29];const ee=U&&ne&&J;let te;e[30]===Symbol.for("react.memo_cache_sentinel")?(te=t.jsx(_t,{className:"w-4 h-4"}),e[30]=te):te=e[30];let ae;e[31]!==u?(ae=t.jsxs("button",{type:"button",onClick:u,className:"flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors mb-3",children:[te,"Back to Select Provider"]}),e[31]=u,e[32]=ae):ae=e[32];let le;e[33]===Symbol.for("react.memo_cache_sentinel")?(le=t.jsx("h1",{className:"text-2xl font-semibold text-foreground mb-2",children:"Patient Details"}),e[33]=le):le=e[33];const me=p?"Sign in, create an account, or continue as guest":"Please provide your information";let Q;e[34]!==me?(Q=t.jsx("p",{className:"text-muted-foreground",children:me}),e[34]=me,e[35]=Q):Q=e[35];let de;e[36]!==ae||e[37]!==Q?(de=t.jsxs("div",{children:[ae,le,Q]}),e[36]=ae,e[37]=Q,e[38]=de):de=e[38];let ce;e[39]!==p?(ce=p&&t.jsxs("div",{className:"bg-card border border-border rounded-xl p-6 space-y-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"How would you like to continue?"}),t.jsx("div",{className:"bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-900 rounded-lg p-3 text-sm text-green-800 dark:text-green-200",children:"Your booking details will be saved. You'll return here after signing in or creating an account."}),t.jsxs("div",{className:"grid gap-3",children:[t.jsxs(se,{type:"button",variant:"outline",onClick:As,className:"w-full justify-start py-6 text-base",children:[t.jsx(hs,{className:"w-5 h-5 mr-3"}),t.jsxs("div",{className:"text-left",children:[t.jsx("div",{children:"Sign in to your account"}),t.jsx("div",{className:"text-xs text-muted-foreground font-normal",children:"Already have an account"})]})]}),t.jsxs(se,{type:"button",variant:"outline",onClick:Ds,className:"w-full justify-start py-6 text-base",children:[t.jsx(js,{className:"w-5 h-5 mr-3"}),t.jsxs("div",{className:"text-left",children:[t.jsx("div",{children:"Create an account"}),t.jsx("div",{className:"text-xs text-muted-foreground font-normal",children:"Save your details for future bookings"})]})]}),t.jsxs("div",{className:"relative py-2",children:[t.jsx("div",{className:"absolute inset-0 flex items-center",children:t.jsx("span",{className:"w-full border-t border-border"})}),t.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:t.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"or"})})]}),t.jsxs(se,{type:"button",variant:"outline",onClick:F,className:"w-full justify-start py-6 text-base",children:[t.jsx(Lt,{className:"w-5 h-5 mr-3"}),t.jsxs("div",{className:"text-left",children:[t.jsx("div",{children:"Continue as guest"}),t.jsx("div",{className:"text-xs text-muted-foreground font-normal",children:"Enter your details below"})]})]})]})]}),e[39]=p,e[40]=ce):ce=e[40];let ue;e[41]!==o.dateOfBirth||e[42]!==o.email||e[43]!==o.firstName||e[44]!==o.guardianConfirmed||e[45]!==o.guardianName||e[46]!==o.lastName||e[47]!==o.nhsNumber||e[48]!==o.notes||e[49]!==o.phone||e[50]!==x||e[51]!==G||e[52]!==i||e[53]!==ee||e[54]!==b||e[55]!==h||e[56]!==_||e[57]!==p||e[58]!==y?(ue=!p&&t.jsxs(t.Fragment,{children:[i&&y.length>0&&t.jsxs("div",{className:"space-y-3",children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Who is this booking for?"}),t.jsxs("div",{className:"grid gap-2 sm:grid-cols-2 md:grid-cols-3",children:[t.jsxs("button",{type:"button",onClick:()=>G(null),className:`flex items-center gap-2 rounded-lg border p-3 text-left transition-colors ${_===null?"border-primary bg-primary/5":"border-border hover:border-primary/50"}`,children:[t.jsx("div",{className:"flex size-8 items-center justify-center rounded-full bg-primary/10",children:t.jsx(kt,{className:"size-4 text-primary"})}),t.jsx("span",{className:"font-medium",children:"Myself"})]}),y.map(L=>t.jsxs("button",{type:"button",onClick:()=>G(L.id),className:`flex items-center gap-2 rounded-lg border p-3 text-left transition-colors ${_===L.id?"border-primary bg-primary/5":"border-border hover:border-primary/50"}`,children:[t.jsx("div",{className:"flex size-8 items-center justify-center rounded-full bg-primary/10",children:t.jsx(is,{className:"size-4 text-primary"})}),t.jsx("span",{className:"font-medium",children:L.full_name})]},L.id))]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{htmlFor:"first-name",className:"text-sm font-medium text-foreground",children:["First Name ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"first-name",type:"text",value:o.firstName,onChange:L=>C("firstName",L.target.value),placeholder:"John","aria-required":"true","aria-invalid":!o.firstName.trim()})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{htmlFor:"last-name",className:"text-sm font-medium text-foreground",children:["Last Name ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"last-name",type:"text",value:o.lastName,onChange:L=>C("lastName",L.target.value),placeholder:"Smith","aria-required":"true","aria-invalid":!o.lastName.trim()})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{htmlFor:"email",className:"text-sm font-medium text-foreground",children:["Email Address ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"email",type:"email",value:o.email,onChange:L=>C("email",L.target.value),placeholder:"john.smith@example.com","aria-required":"true","aria-invalid":!z(o.email)})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{htmlFor:"phone",className:"text-sm font-medium text-foreground",children:["Phone Number ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"phone",type:"tel",value:o.phone,onChange:L=>C("phone",L.target.value),placeholder:"07XXX XXXXXX","aria-required":"true","aria-invalid":!D(o.phone)})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{htmlFor:"dob",className:"text-sm font-medium text-foreground",children:["Date of Birth ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"dob",type:"date",value:o.dateOfBirth,onChange:L=>C("dateOfBirth",L.target.value),max:new Date().toISOString().split("T")[0],"aria-required":"true"})]}),h&&t.jsxs("div",{className:"space-y-4 p-4 bg-accent/30 rounded-xl border border-border transition-all duration-300 ease-in-out animate-in",role:"region","aria-label":"Guardian information required","aria-live":"polite",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("div",{className:"h-1.5 w-1.5 rounded-full bg-primary animate-pulse"}),t.jsx("h3",{className:"text-sm font-semibold text-foreground",children:"Guardian Information Required"})]}),t.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Since the patient is under 16 years old, a guardian must be present."}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{htmlFor:"guardian-name",className:"text-sm font-medium text-foreground",children:["Guardian Name (Adult with Parental Responsibility) ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"guardian-name",type:"text",value:o.guardianName||"",onChange:L=>C("guardianName",L.target.value),placeholder:"Full name of parent or legal guardian","aria-required":"true"})]}),t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx($e,{id:"guardian-confirm",checked:o.guardianConfirmed||!1,onCheckedChange:L=>C("guardianConfirmed",L===!0),className:"mt-0.5","aria-required":"true"}),t.jsx("label",{htmlFor:"guardian-confirm",className:"text-sm text-muted-foreground cursor-pointer",children:"I confirm that I have parental responsibility for this child and will be present at the blood draw. (We will need to check your ID)"})]})]}),b&&t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{htmlFor:"nhs-number",className:"text-sm font-medium text-foreground",children:["NHS Number ",t.jsx("span",{className:"text-destructive",children:"*"})]}),t.jsx(ge,{id:"nhs-number",type:"text",value:o.nhsNumber||"",onChange:L=>C("nhsNumber",L.target.value.replace(/\D/g,"").slice(0,10)),placeholder:"1234567890",maxLength:10}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Enter your 10-digit NHS number"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{htmlFor:"notes",className:"text-sm font-medium text-foreground",children:"Special Instructions (Optional)"}),t.jsx(os,{id:"notes",value:o.notes||"",onChange:L=>C("notes",L.target.value),placeholder:"E.g. specific collection requirements, accessibility needs, or previous issues with blood draws...",rows:4,className:"resize-none placeholder:text-muted-foreground/60 placeholder:italic"})]}),t.jsx("div",{className:"p-4 bg-accent/30 rounded-xl border border-border",children:t.jsx("p",{className:"text-sm text-muted-foreground",children:"By continuing, you agree to our terms of service and consent to the collection and processing of your personal data for the purpose of this blood test appointment."})}),t.jsx("div",{className:"pt-4",children:t.jsx(se,{onClick:x,disabled:!ee,className:"w-full py-6 text-base",size:"lg",children:"Continue to Payment"})})]}),e[41]=o.dateOfBirth,e[42]=o.email,e[43]=o.firstName,e[44]=o.guardianConfirmed,e[45]=o.guardianName,e[46]=o.lastName,e[47]=o.nhsNumber,e[48]=o.notes,e[49]=o.phone,e[50]=x,e[51]=G,e[52]=i,e[53]=ee,e[54]=b,e[55]=h,e[56]=_,e[57]=p,e[58]=y,e[59]=ue):ue=e[59];let S;return e[60]!==de||e[61]!==ce||e[62]!==ue?(S=t.jsxs("div",{className:"space-y-6",children:[de,ce,ue]}),e[60]=de,e[61]=ce,e[62]=ue,e[63]=S):S=e[63],S}function Ds(){return at.visit("/register?redirect=/book")}function As(){return at.visit("/login?redirect=/book")}function Fs(s){return{...s,isGuest:!0}}function Is(s){return s?new Date(s)<new Date:!1}function $s(s){return/^\d{10}$/.test(s.replace(/\s/g,""))}function Rs(s){const e=s.replace(/[\s\-()]/g,"");return/^(\+?\d{10,15})$/.test(e)}function Bs(s){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)}function Os(s){if(!s)return!1;const e=new Date(s),r=new Date;let i=r.getFullYear()-e.getFullYear();const d=r.getMonth()-e.getMonth(),l=r.getDate()-e.getDate();return(d<0||d===0&&l<0)&&i--,i<16}let Ue=null,Nt="";function zs(s){return Ue&&Nt===s||(Nt=s,Ue=Ht(s)),Ue}function Us({amount:s,termsAccepted:e=!0,onPaymentSuccess:r,onPaymentError:i,children:d}){const l=Kt(),y=Vt(),[a,b]=c.useState(!1),m=c.useRef(!0);c.useEffect(()=>()=>{m.current=!1},[]);const n=async u=>{if(u.preventDefault(),!(!l||!y)){b(!0);try{const{error:p,paymentIntent:w}=await l.confirmPayment({elements:y,confirmParams:{return_url:`${window.location.origin}/book/success`},redirect:"if_required"});if(!m.current)return;p?(i(p.message||"Payment failed"),V.error(p.message||"Payment failed")):w&&w.status==="succeeded"&&r(w.id)}catch(p){if(!m.current)return;console.error("Payment error:",p),i("An unexpected error occurred"),V.error("An unexpected error occurred")}finally{m.current&&b(!1)}}};return t.jsxs("form",{onSubmit:n,className:"space-y-4",children:[t.jsx(qt,{}),d,t.jsx(se,{type:"submit",disabled:!l||a||!e,className:"w-full py-6 text-base",size:"lg",children:a?t.jsxs(t.Fragment,{children:[t.jsx(De,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):`Pay £${s.toFixed(2)}`}),t.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"Your payment is secured by Stripe. We never store your card details."})]})}function Hs(s){const e=be.c(27),{clientSecret:r,amount:i,stripePublicKey:d,termsAccepted:l,onPaymentSuccess:y,onPaymentError:a,children:b}=s;let m;e[0]!==d?(m=d?zs(d):null,e[0]=d,e[1]=m):m=e[1];const n=m,[u,p]=c.useState(!1);let w,R;if(e[2]===Symbol.for("react.memo_cache_sentinel")?(w=()=>{const D=()=>{p(document.documentElement.classList.contains("dark"))};D();const Z=new MutationObserver(D);return Z.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>Z.disconnect()},R=[],e[2]=w,e[3]=R):(w=e[2],R=e[3]),c.useEffect(w,R),!n||!r){let D;return e[4]===Symbol.for("react.memo_cache_sentinel")?(D=t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx(De,{className:"h-6 w-6 animate-spin text-primary"})}),e[4]=D):D=e[4],D}const _=u?"night":"stripe",T=u?"#3b82f6":"#0570de",P=u?"#1f2937":"#ffffff",o=u?"#f3f4f6":"#1f2937",A=u?"#ef4444":"#df1b41";let M;e[5]!==T||e[6]!==P||e[7]!==o||e[8]!==A?(M={colorPrimary:T,colorBackground:P,colorText:o,colorDanger:A,fontFamily:"system-ui, sans-serif",borderRadius:"0.75rem"},e[5]=T,e[6]=P,e[7]=o,e[8]=A,e[9]=M):M=e[9];let E;e[10]!==_||e[11]!==M?(E={theme:_,variables:M},e[10]=_,e[11]=M,e[12]=E):E=e[12];let N;e[13]!==r||e[14]!==E?(N={clientSecret:r,appearance:E},e[13]=r,e[14]=E,e[15]=N):N=e[15];const h=N,k=u?"dark":"light";let C;e[16]!==i||e[17]!==b||e[18]!==a||e[19]!==y||e[20]!==l?(C=t.jsx(Us,{amount:i,termsAccepted:l,onPaymentSuccess:y,onPaymentError:a,children:b}),e[16]=i,e[17]=b,e[18]=a,e[19]=y,e[20]=l,e[21]=C):C=e[21];let z;return e[22]!==h||e[23]!==n||e[24]!==k||e[25]!==C?(z=t.jsx(Gt,{stripe:n,options:h,children:C},k),e[22]=h,e[23]=n,e[24]=k,e[25]=C,e[26]=z):z=e[26],z}function Gs({stripePublicKey:s,userPaymentMethods:e=[]}){const{selectedServices:r,bookedServices:i,collectionType:d,location:l,selectedDate:y,selectedSlot:a,selectedProvider:b,patientDetails:m,draftId:n,paymentIntentClientSecret:u,promoCode:p,discount:w,setDraftId:R,setPaymentIntentClientSecret:_,setPromoCode:T,setDiscount:P,setStep:o,goBack:A,setConfirmationNumber:M}=Pe(),{createDraft:E,createPaymentIntent:N,applyPromoCode:h,confirmBooking:k}=Ke(),{auth:C}=rt().props,z=!!C?.user,[D,Z]=c.useState(""),[q,g]=c.useState(e.length===0),[F,H]=c.useState(p||""),[G,j]=c.useState(!1),[x,B]=c.useState(!1),[U,Y]=c.useState(!1),[ne,J]=c.useState(!1),[ie,ee]=c.useState(!1),[te,ae]=c.useState(0);c.useEffect(()=>{if(e.length>0&&!D){const S=e.find(L=>L.is_default);S&&(Z(S.id),g(!1))}},[e]),c.useEffect(()=>{const S=y&&l&&m&&a&&b&&r.length>0,L=z||m?.isGuest;!ie&&S&&L&&(n?u||(ee(!0),me(n)):(ee(!0),le()))},[ie,n,u,y,l,m,a,b,r,z]);const le=async()=>{if(!(!y||!l||!m||!a||!b||r.length===0))try{const S={collection_type:d||"home_visit",is_nhs_test:!1,service_ids:(i.length>0?i:r).map(X=>X.id),location:{postcode:l.postcode,address:l.address,address_line1:l.addressLine1,address_line2:l.addressLine2,city:l.townCity},selected_date:Ie(y,"yyyy-MM-dd"),time_slot:a.time,provider_id:b?.id,patient_details:{first_name:m.firstName,last_name:m.lastName,email:m.email,phone:m.phone,date_of_birth:m.dateOfBirth,nhs_number:m.nhsNumber,is_under_16:m.isUnder16,guardian_name:m.guardianName,guardian_confirmed:m.guardianConfirmed,notes:m.notes}};l.addressLine1&&(S.service_address_line1=l.addressLine1,S.service_address_line2=l.addressLine2||null,S.service_town_city=l.townCity,S.service_postcode=l.postcode),!z&&m.isGuest&&(S.guest_name=`${m.firstName} ${m.lastName}`,S.guest_email=m.email,S.guest_phone=m.phone);const L=await E(S);R(L.id),await me(L.id)}catch(S){console.error("Error creating draft:",S),V.error(S?.message||"Failed to prepare payment. Please try again.")}},me=async S=>{Y(!0);try{const{clientSecret:L,amount:X}=await N(S);_(L),ae(X/100)}catch(L){console.error("Error creating payment intent:",L),V.error(L?.message||"Failed to initialize payment. Please try again.")}finally{Y(!1)}},Q=async()=>{if(!F.trim()||!n){V.error("Please enter a promo code");return}j(!0);try{const S=await h(n,F.trim());T(S.code),P(S.discount),V.success(`Promo code applied! £${S.discount.toFixed(2)} discount`)}catch(S){V.error(S.message||"Invalid promo code")}finally{j(!1)}},de=async S=>{if(!n){V.error("Booking information missing");return}J(!0);try{const L=await k(S,n);L.confirmationNumber&&M(L.confirmationNumber),o("success")}catch(L){console.error("Error confirming booking:",L),V.error("Payment succeeded but booking confirmation failed. Please contact support.")}finally{J(!1)}},ce=S=>{console.error("Payment error:",S),V.error(S)},ue=te;return U?t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Preparing payment..."})]})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx(it,{label:"Back to Patient Details",onClick:A}),t.jsx("h1",{className:"text-2xl font-semibold text-foreground mb-2",children:"Payment"}),t.jsx("p",{className:"text-muted-foreground",children:"Complete your payment"})]}),!w&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Promo Code"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(vs,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),t.jsx(ge,{type:"text",placeholder:"Enter code",value:F,onChange:S=>H(S.target.value.toUpperCase()),className:"pl-10"})]}),t.jsx(se,{type:"button",variant:"outline",onClick:Q,disabled:G||!F.trim(),children:G?"Applying...":"Apply"})]})]}),e.length>0&&!q&&t.jsxs("div",{className:"space-y-3",children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Saved Payment Methods"}),t.jsx("div",{className:"space-y-2",children:e.map(S=>t.jsx("button",{type:"button",onClick:()=>Z(S.id),className:re("w-full p-4 rounded-xl border-2 transition-all text-left",D===S.id?"border-primary bg-primary/5":"border-border hover:border-primary/50"),children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(ls,{className:"w-5 h-5 text-muted-foreground"}),t.jsxs("div",{children:[t.jsxs("div",{className:"font-medium text-foreground capitalize",children:[S.card_brand," •••• ",S.card_last_four]}),t.jsxs("div",{className:"text-sm text-muted-foreground",children:["Expires ",S.card_exp_month,"/",S.card_exp_year]})]})]}),D===S.id&&t.jsx(_e,{className:"w-5 h-5 text-primary"})]})},S.id))}),t.jsx(se,{type:"button",variant:"outline",onClick:()=>g(!0),className:"w-full",children:"Use a different card"}),t.jsxs("div",{className:"flex items-start gap-3 p-4 bg-accent/30 rounded-xl border border-border mt-4",children:[t.jsx($e,{id:"terms-saved",checked:x,onCheckedChange:S=>B(S===!0),className:"mt-0.5"}),t.jsxs("label",{htmlFor:"terms-saved",className:"text-sm text-muted-foreground cursor-pointer",children:["I confirm that all booking information is correct and I accept the"," ",t.jsx("a",{href:"/terms",target:"_blank",className:"text-primary hover:underline",children:"terms and conditions"})," ","and"," ",t.jsx("a",{href:"/privacy",target:"_blank",className:"text-primary hover:underline",children:"privacy policy"})]})]})]}),(q||e.length===0)&&t.jsxs("div",{className:"space-y-4",children:[e.length>0&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Card Details"}),t.jsx(se,{type:"button",variant:"ghost",size:"sm",onClick:()=>g(!1),className:"text-xs",children:"Use saved card"})]}),u&&t.jsx(Hs,{clientSecret:u,amount:ue,stripePublicKey:s,termsAccepted:x,onPaymentSuccess:de,onPaymentError:ce,children:t.jsxs("div",{className:"flex items-start gap-3 p-4 bg-accent/30 rounded-xl border border-border",children:[t.jsx($e,{id:"terms",checked:x,onCheckedChange:S=>B(S===!0),className:"mt-0.5"}),t.jsxs("label",{htmlFor:"terms",className:"text-sm text-muted-foreground cursor-pointer",children:["I confirm that all booking information is correct and I accept the"," ",t.jsx("a",{href:"/terms",target:"_blank",className:"text-primary hover:underline",children:"terms and conditions"})," ","and"," ",t.jsx("a",{href:"/privacy",target:"_blank",className:"text-primary hover:underline",children:"privacy policy"})]})]})})]}),!q&&e.length>0&&t.jsx("div",{className:"pt-4",children:t.jsx(se,{onClick:()=>{V.info("Saved payment method flow not yet implemented")},disabled:!x||!D||ne,className:"w-full py-6 text-base",size:"lg",children:ne?"Processing...":`Pay £${ue.toFixed(2)}`})})]})}const wt=["#22c55e","#3b82f6","#eab308","#ef4444","#a855f7","#f97316","#06b6d4","#ec4899"];function Ks(s){return Array.from({length:s},(e,r)=>({id:r,x:Math.random()*100,delay:Math.random()*.8,duration:1.5+Math.random()*2,color:wt[r%wt.length],size:5+Math.random()*7,isCircle:Math.random()>.5}))}function Vs(){const s=be.c(4);let e;s[0]===Symbol.for("react.memo_cache_sentinel")?(e=Ks(50),s[0]=e):e=s[0];const r=e,[i,d]=c.useState(!0);let l,y;if(s[1]===Symbol.for("react.memo_cache_sentinel")?(l=()=>{const b=setTimeout(()=>d(!1),4e3);return()=>clearTimeout(b)},y=[],s[1]=l,s[2]=y):(l=s[1],y=s[2]),c.useEffect(l,y),!i)return null;let a;return s[3]===Symbol.for("react.memo_cache_sentinel")?(a=t.jsx("div",{className:"fixed inset-0 pointer-events-none overflow-hidden z-50","aria-hidden":"true",children:r.map(qs)}),s[3]=a):a=s[3],a}function qs(s){return t.jsx("div",{className:"absolute animate-confetti-fall",style:{left:`${s.x}%`,top:"-12px",width:s.size,height:s.isCircle?s.size:s.size*.6,backgroundColor:s.color,borderRadius:s.isCircle?"50%":"2px",animationDelay:`${s.delay}s`,animationDuration:`${s.duration}s`}},s.id)}function Ys(){const s=be.c(2);let e;s[0]===Symbol.for("react.memo_cache_sentinel")?(e=t.jsx("div",{className:"absolute inset-[-8px] rounded-full bg-green-500/20 dark:bg-green-400/15 animate-success-glow"}),s[0]=e):e=s[0];let r;return s[1]===Symbol.for("react.memo_cache_sentinel")?(r=t.jsxs("div",{className:"relative w-28 h-28",children:[e,t.jsxs("svg",{className:"w-28 h-28 relative z-10",viewBox:"0 0 52 52",children:[t.jsx("circle",{className:"animate-checkmark-circle",cx:"26",cy:"26",r:"24",fill:"none",strokeWidth:"2"}),t.jsx("path",{className:"animate-checkmark-check",fill:"none",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",d:"M14.1 27.2l7.1 7.2 16.7-16.8"})]})]}),s[1]=r):r=s[1],r}function Xs(){const s=be.c(71),{selectedProvider:e,selectedDate:r,selectedSlot:i,location:d,bookedServices:l,selectedServices:y,providerServicePrices:a,confirmationNumber:b,totalAmount:m,clearBooking:n}=Pe(),[u,p]=c.useState(!1);let w,R;s[0]===Symbol.for("react.memo_cache_sentinel")?(w=()=>{const X=setTimeout(()=>p(!0),500);return()=>clearTimeout(X)},R=[],s[0]=w,s[1]=R):(w=s[0],R=s[1]),c.useEffect(w,R);let _;s[2]!==n?(_=X=>{n(),at.visit(X)},s[2]=n,s[3]=_):_=s[3];const T=_,P=l.length>0?l:y;let o;e:{if(m>0){o=m;break e}let X;if(s[4]!==a||s[5]!==P){let f;s[7]!==a?(f=(K,W)=>K+(a[W.id]||0),s[7]=a,s[8]=f):f=s[8],X=P.reduce(f,0),s[4]=a,s[5]=P,s[6]=X}else X=s[6];o=X}const A=o;let M;s[9]!==u?(M=u&&t.jsx(Vs,{}),s[9]=u,s[10]=M):M=s[10];let E;s[11]===Symbol.for("react.memo_cache_sentinel")?(E=t.jsx("div",{className:"flex justify-center mb-6",children:t.jsx(Ys,{})}),s[11]=E):E=s[11];let N,h,k;s[12]===Symbol.for("react.memo_cache_sentinel")?(N={animationDelay:"0.6s",animationFillMode:"both"},h=t.jsx("h1",{className:"text-3xl font-bold text-foreground mb-2",children:"Booking Confirmed!"}),k=t.jsx("p",{className:"text-lg text-muted-foreground",children:"Your appointment has been successfully booked"}),s[12]=N,s[13]=h,s[14]=k):(N=s[12],h=s[13],k=s[14]);let C;s[15]!==b?(C=b&&t.jsxs("div",{className:"mt-3 inline-flex items-center gap-2 px-4 py-2 bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-full",children:[t.jsx("span",{className:"text-sm text-green-700 dark:text-green-300",children:"Confirmation"}),t.jsx("span",{className:"font-mono font-bold text-green-800 dark:text-green-200",children:b})]}),s[15]=b,s[16]=C):C=s[16];let z;s[17]!==C?(z=t.jsxs("div",{className:"text-center mb-8 animate-in fade-in duration-500",style:N,children:[h,k,C]}),s[17]=C,s[18]=z):z=s[18];let D;s[19]===Symbol.for("react.memo_cache_sentinel")?(D={animationDelay:"0.9s",animationFillMode:"both"},s[19]=D):D=s[19];let Z;s[20]===Symbol.for("react.memo_cache_sentinel")?(Z=t.jsx("h2",{className:"text-lg font-semibold text-foreground mb-4",children:"Appointment Details"}),s[20]=Z):Z=s[20];let q;s[21]!==e?(q=e&&t.jsxs("div",{className:"flex items-center gap-3 mb-5 pb-5 border-b border-border",children:[e.user?.profile_image?t.jsx("img",{src:e.user.profile_image,alt:e.user?.full_name||"Provider",className:"w-12 h-12 rounded-full object-cover"}):t.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center",children:t.jsx("span",{className:"text-lg font-semibold text-primary",children:(e.user?.full_name||e.name||"P").charAt(0)})}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-foreground",children:e.user?.full_name||e.name}),e.type&&t.jsx("p",{className:"text-sm text-muted-foreground",children:e.type.name})]})]}),s[21]=e,s[22]=q):q=s[22];let g;s[23]!==r?(g=r&&t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx(nt,{className:"w-4 h-4 text-primary"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Date"}),t.jsx("p",{className:"font-medium text-foreground",children:Ie(r,"EEEE, d MMMM yyyy")})]})]}),s[23]=r,s[24]=g):g=s[24];let F;s[25]!==i?(F=i&&t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx(He,{className:"w-4 h-4 text-primary"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Time"}),t.jsx("p",{className:"font-medium text-foreground",children:i.time})]})]}),s[25]=i,s[26]=F):F=s[26];let H;s[27]!==d?(H=d&&t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center shrink-0",children:t.jsx(Ce,{className:"w-4 h-4 text-primary"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Location"}),t.jsx("p",{className:"font-medium text-foreground",children:d.address||d.postcode})]})]}),s[27]=d,s[28]=H):H=s[28];let G;s[29]!==g||s[30]!==F||s[31]!==H?(G=t.jsxs("div",{className:"space-y-3 mb-5 pb-5 border-b border-border",children:[g,F,H]}),s[29]=g,s[30]=F,s[31]=H,s[32]=G):G=s[32];let j;s[33]!==a||s[34]!==P||s[35]!==A?(j=P.length>0&&t.jsxs("div",{children:[t.jsx("p",{className:"text-xs font-medium text-muted-foreground mb-3",children:"Services Booked"}),t.jsx("div",{className:"space-y-2",children:P.map(X=>t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(_e,{className:"w-4 h-4 text-green-500"}),t.jsx("span",{className:"text-sm text-foreground",children:X.service_name})]}),a[X.id]!==void 0&&t.jsxs("span",{className:"text-sm font-medium text-foreground",children:["£",a[X.id].toFixed(2)]})]},X.id))}),A>0&&t.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-border",children:[t.jsx("span",{className:"font-semibold text-foreground",children:"Total Paid"}),t.jsxs("span",{className:"text-lg font-bold text-primary",children:["£",A.toFixed(2)]})]})]}),s[33]=a,s[34]=P,s[35]=A,s[36]=j):j=s[36];let x;s[37]!==q||s[38]!==G||s[39]!==j?(x=t.jsx("div",{className:"bg-card border border-border rounded-2xl overflow-hidden mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500",style:D,children:t.jsxs("div",{className:"p-6",children:[Z,q,G,j]})}),s[37]=q,s[38]=G,s[39]=j,s[40]=x):x=s[40];let B,U;s[41]===Symbol.for("react.memo_cache_sentinel")?(B={animationDelay:"1.1s",animationFillMode:"both"},U=t.jsx("h3",{className:"font-semibold text-foreground mb-3",children:"What's Next"}),s[41]=B,s[42]=U):(B=s[41],U=s[42]);let Y;s[43]===Symbol.for("react.memo_cache_sentinel")?(Y=t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5",children:t.jsx(Lt,{className:"w-3.5 h-3.5 text-primary"})}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"A confirmation email has been sent with your appointment details"})]}),s[43]=Y):Y=s[43];let ne;s[44]===Symbol.for("react.memo_cache_sentinel")?(ne=t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5",children:t.jsx(He,{className:"w-3.5 h-3.5 text-primary"})}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Your provider will confirm the appointment shortly"})]}),s[44]=ne):ne=s[44];let J;s[45]===Symbol.for("react.memo_cache_sentinel")?(J=t.jsxs("div",{className:"bg-accent/30 border border-border rounded-2xl p-6 mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500",style:B,children:[U,t.jsxs("div",{className:"space-y-3",children:[Y,ne,t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5",children:t.jsx(gt,{className:"w-3.5 h-3.5 text-primary"})}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"You can manage this appointment from your dashboard"})]})]})]}),s[45]=J):J=s[45];let ie;s[46]===Symbol.for("react.memo_cache_sentinel")?(ie={animationDelay:"1.4s",animationFillMode:"both"},s[46]=ie):ie=s[46];let ee;s[47]!==T?(ee=()=>T("/bookings"),s[47]=T,s[48]=ee):ee=s[48];let te;s[49]===Symbol.for("react.memo_cache_sentinel")?(te=t.jsx(ds,{className:"w-4 h-4 ml-2"}),s[49]=te):te=s[49];let ae;s[50]!==ee?(ae=t.jsxs(se,{onClick:ee,size:"lg",className:"flex-1 py-6 text-base",children:["View My Bookings",te]}),s[50]=ee,s[51]=ae):ae=s[51];let le;s[52]!==T?(le=()=>T("/book"),s[52]=T,s[53]=le):le=s[53];let me;s[54]===Symbol.for("react.memo_cache_sentinel")?(me=t.jsx(gt,{className:"w-4 h-4 mr-2"}),s[54]=me):me=s[54];let Q;s[55]!==le?(Q=t.jsxs(se,{onClick:le,variant:"outline",size:"lg",className:"flex-1 py-6 text-base",children:[me,"Book Another"]}),s[55]=le,s[56]=Q):Q=s[56];let de;s[57]!==T?(de=()=>T("/"),s[57]=T,s[58]=de):de=s[58];let ce;s[59]===Symbol.for("react.memo_cache_sentinel")?(ce=t.jsx(ot,{className:"w-4 h-4 mr-2"}),s[59]=ce):ce=s[59];let ue;s[60]!==de?(ue=t.jsxs(se,{onClick:de,variant:"ghost",size:"lg",className:"sm:flex-initial px-6 py-6 text-base",children:[ce,"Home"]}),s[60]=de,s[61]=ue):ue=s[61];let S;s[62]!==ae||s[63]!==Q||s[64]!==ue?(S=t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 animate-in fade-in duration-500",style:ie,children:[ae,Q,ue]}),s[62]=ae,s[63]=Q,s[64]=ue,s[65]=S):S=s[65];let L;return s[66]!==z||s[67]!==x||s[68]!==S||s[69]!==M?(L=t.jsxs("div",{className:"relative max-w-2xl mx-auto py-4",children:[M,E,z,x,J,S]}),s[66]=z,s[67]=x,s[68]=S,s[69]=M,s[70]=L):L=s[70],L}function Ws(s){const e=be.c(28),{pageProps:r}=s,{step:i,goToStep:d}=Pe();let l;e[0]!==r||e[1]!==i?(l=()=>{switch(i){case"collection":return t.jsx(yt,{});case"location":return t.jsx(Ss,{userAddresses:r.userAddresses,googleMapsKey:r.googleMapsKey,isAuthenticated:!!r.auth?.user});case"provider":return t.jsx(Ts,{googleMapsKey:r.googleMapsKey});case"patient":return t.jsx(Ls,{userData:r.userData,isAuthenticated:!!r.auth?.user,userDependents:r.userDependents});case"payment":return t.jsx(Gs,{stripePublicKey:r.stripePublicKey||"",userPaymentMethods:r.userPaymentMethods});case"success":return t.jsx(Xs,{});default:return t.jsx(yt,{})}},e[0]=r,e[1]=i,e[2]=l):l=e[2];const y=l;if(i==="success"){let P;e[3]===Symbol.for("react.memo_cache_sentinel")?(P=t.jsx(ut,{title:"Booking Confirmed"}),e[3]=P):P=e[3];let o;return e[4]!==y?(o=t.jsxs(t.Fragment,{children:[P,t.jsx("div",{className:"min-h-screen bg-background",children:t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsx("main",{className:"max-w-3xl mx-auto",children:y()})})})]}),e[4]=y,e[5]=o):o=e[5],o}let a;e[6]!==i?(a=i.charAt(0).toUpperCase(),e[6]=i,e[7]=a):a=e[7];const b=`Book Appointment - ${a+i.slice(1)}`;let m;e[8]!==b?(m=t.jsx(ut,{title:b}),e[8]=b,e[9]=m):m=e[9];let n;e[10]!==d||e[11]!==i?(n=t.jsx("div",{className:"hidden lg:block sticky top-20",children:t.jsx(vt,{currentStep:i,onStepClick:d})}),e[10]=d,e[11]=i,e[12]=n):n=e[12];let u;e[13]!==d||e[14]!==i?(u=t.jsx("div",{className:"lg:hidden",children:t.jsx(vt,{currentStep:i,onStepClick:d})}),e[13]=d,e[14]=i,e[15]=u):u=e[15];let p;e[16]!==y?(p=y(),e[16]=y,e[17]=p):p=e[17];let w;e[18]!==u||e[19]!==p?(w=t.jsxs("main",{className:"max-w-3xl lg:mx-0 mx-auto",children:[u,p]}),e[18]=u,e[19]=p,e[20]=w):w=e[20];let R;e[21]===Symbol.for("react.memo_cache_sentinel")?(R=t.jsx("div",{className:"hidden lg:block sticky top-20",children:t.jsx(ks,{})}),e[21]=R):R=e[21];let _;e[22]!==n||e[23]!==w?(_=t.jsx("div",{className:"min-h-screen bg-background",children:t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsxs("div",{className:"lg:grid lg:grid-cols-[280px_1fr_320px] lg:gap-8 lg:items-start",children:[n,w,R]})})}),e[22]=n,e[23]=w,e[24]=_):_=e[24];let T;return e[25]!==_||e[26]!==m?(T=t.jsxs(t.Fragment,{children:[m,_]}),e[25]=_,e[26]=m,e[27]=T):T=e[27],T}function Zs(s){const e=be.c(2);let r;return e[0]!==s?(r=t.jsx(ws,{children:t.jsx(Ws,{pageProps:s})}),e[0]=s,e[1]=r):r=e[1],r}Zs.layout=s=>t.jsx(Ut,{hideFooter:!0,children:s});export{Zs as default};
