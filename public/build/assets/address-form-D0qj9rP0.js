import{a as we,j as e,F as Ne,t as l}from"./app-DKMZLzfm.js";import{r as n}from"./stripe-DEhpSmJl.js";import{B as L}from"./button-BpuFCFGL.js";import{I as w}from"./input-aT928qqq.js";import{u as Se,N as Le,M as Ce,L as Te,I as _e}from"./location-selector-map-Cut6Ba49.js";import{L as f}from"./label-CLkqaWUk.js";import{C as Ae}from"./checkbox-DvFPy7ur.js";import{L as F}from"./loader-circle-C-jBiGq1.js";import{C as Pe}from"./chevron-up-BgviQ73B.js";import{C as ke}from"./chevron-down-Ob_WsXKC.js";import{M as Z}from"./map-pin-6HZ9aDy_.js";import{H as Ie}from"./house-DAg0O8J9.js";function $e({initialData:i,action:D,method:ee,onCancel:te}){const{googleMapsKey:se}=we().props,{isLoaded:d,libraries:C}=Se(se),[y,oe]=n.useState(!1),[E,T]=n.useState(!1),[N,m]=n.useState(!1),[ne,M]=n.useState(i?.latitude&&i?.longitude?{lat:i.latitude,lng:i.longitude}:{lat:51.5074,lng:-.1278}),[ae,re]=n.useState(i?.label||""),[G,U]=n.useState(i?.address_line1||""),[le,R]=n.useState(i?.address_line2||""),[K,B]=n.useState(i?.town_city||""),[j,_]=n.useState(i?.postcode||""),[ie,H]=n.useState(i?.latitude),[ce,q]=n.useState(i?.longitude),[O,de]=n.useState(i?.is_default||!1),[ue,W]=n.useState(!!i?.postcode),[v,A]=n.useState(""),[Y,x]=n.useState([]),[me,$]=n.useState(!1),[pe,h]=n.useState(!1),[b,z]=n.useState(null),P=n.useRef(null),k=n.useRef(null),I=n.useRef(void 0),V=async s=>{if(!s.addressComponents||!s.location){l.error("Could not get address details");return}const t=s.addressComponents;let o="",a="",r="",p="",g="",u="";for(const c of t)c.types.includes("street_number")&&(o=c.longText||""),c.types.includes("route")&&(a=c.longText||""),c.types.includes("subpremise")&&(r=c.longText||""),c.types.includes("locality")&&(p=c.longText||""),c.types.includes("postal_town")&&(g=c.longText||""),c.types.includes("postal_code")&&(u=c.longText||"");const je=[o,a].filter(Boolean).join(" "),ve=r,be=g||p,Q=s.location.lat(),X=s.location.lng();U(je),R(ve),B(be),_(u),H(Q),q(X),M({lat:Q,lng:X}),m(!1),W(!0),l.success("Address found")},J=async(s,t)=>{if(!d||!C)return l.error("Google Maps is not loaded"),!1;try{const a=await new google.maps.Geocoder().geocode({location:{lat:s,lng:t}});if(a.results&&a.results.length>0){const r=a.results[0],p=r.address_components.find(u=>u.types.includes("country"));if(!p||p.short_name!=="GB")return m(!0),!1;const g={addressComponents:r.address_components.map(u=>({longText:u.long_name,shortText:u.short_name,types:u.types})),location:r.geometry.location};return await V(g),!0}else return await S(s,t),!N}catch(o){return console.error("Google reverse geocoding error:",o),await S(s,t),!N}},S=async(s,t)=>{try{const o=await fetch(`https://api.postcodes.io/postcodes?lon=${t}&lat=${s}&limit=1`);if(!o.ok)throw new Error(`API responded with status ${o.status}`);const a=await o.json();if(a.status===200&&a.result&&a.result.length>0){const r=a.result[0];_(r.postcode),H(r.latitude),q(r.longitude),M({lat:r.latitude,lng:r.longitude}),m(!1),W(!0)}else m(!0)}catch(o){console.error("Postcode API error:",o),m(!0)}};n.useEffect(()=>{d&&!b&&(async()=>{try{const{AutocompleteSessionToken:t}=await google.maps.importLibrary("places");z(new t)}catch(t){console.error("Error creating session token:",t)}})()},[d,b]);const ge=n.useCallback(async s=>{if(!d||!b||s.length<5){x([]);return}$(!0);try{const{AutocompleteSuggestion:t}=await google.maps.importLibrary("places"),o=await t.fetchAutocompleteSuggestions({input:s,sessionToken:b,includedRegionCodes:["gb"]});x(o.suggestions||[]),h(!0)}catch(t){console.error("Error fetching suggestions:",t),x([])}finally{$(!1)}},[d,b]),xe=s=>{const t=s.target.value;if(A(t),I.current&&clearTimeout(I.current),t.length<5){x([]),h(!1);return}I.current=setTimeout(()=>{ge(t)},500)},he=async s=>{if(!s.placePrediction){l.error("Invalid suggestion");return}try{const t=s.placePrediction.toPlace();if(await t.fetchFields({fields:["addressComponents","location","formattedAddress"]}),!t.location){l.error("No location details available for this address");return}await V(t);const o=s.placePrediction.structuredFormat?.mainText?.text||s.placePrediction.text?.text||"";A(o),h(!1),x([]);const{AutocompleteSessionToken:a}=await google.maps.importLibrary("places");z(new a)}catch(t){console.error("Error selecting suggestion:",t),l.error("Failed to get address details")}};n.useEffect(()=>{const s=t=>{P.current&&!P.current.contains(t.target)&&k.current&&!k.current.contains(t.target)&&h(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),n.useEffect(()=>{const s=t=>{t.key==="Escape"&&h(!1)};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]);const fe=()=>{if(!navigator.geolocation){l.error("Geolocation is not supported by your browser");return}T(!0),l.loading("Getting your location...",{id:"getting-location"}),navigator.geolocation.getCurrentPosition(async s=>{const t=s.coords.latitude,o=s.coords.longitude;try{let a=!1;d&&C?a=await J(t,o):(await S(t,o),a=!N),a?l.success("Current location found",{id:"getting-location"}):l.error("Your location is outside the UK. Please enter a UK address manually.",{id:"getting-location"})}catch(a){console.error("Reverse geocoding error:",a),m(!0),l.error("Your location is outside the UK. Please enter a UK address manually.",{id:"getting-location"})}finally{T(!1)}},s=>{console.error("Geolocation error:",s);let t="Failed to get your location";switch(s.code){case s.PERMISSION_DENIED:t="Location permission denied. Please enable location access in your browser settings.";break;case s.POSITION_UNAVAILABLE:t="Location information unavailable. Please try again or enter postcode manually.";break;case s.TIMEOUT:t="Location request timed out. Please try again.";break}l.error(t,{id:"getting-location"}),T(!1)},{enableHighAccuracy:!1,timeout:15e3,maximumAge:6e4})},ye=async s=>{try{let t=!1;d&&C?t=await J(s.lat,s.lng):(await S(s.lat,s.lng),t=!N),t||l.error("This location is outside the UK. Please select a UK location.")}catch(t){console.error("Reverse geocoding error:",t),m(!0),l.error("This location is outside the UK. Please select a UK location.")}};return e.jsx(Ne,{action:D,method:ee,className:"space-y-6",children:({processing:s,errors:t})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(f,{htmlFor:"label",children:["Label ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(w,{id:"label",name:"label",value:ae,onChange:o=>re(o.target.value),placeholder:"e.g., Home, Work, Mum's House",required:!0}),t.label&&e.jsx("p",{className:"text-sm text-destructive",children:t.label})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Search for Address"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{type:"button",variant:"outline",onClick:fe,disabled:E,className:"flex-1 h-11",children:E?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}),"Getting Location..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),"Use Current Location"]})}),e.jsxs(L,{type:"button",variant:"outline",onClick:()=>{const o=!y;oe(o),o&&(A(""),x([]),h(!1))},className:"flex-1 h-11",children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),y?"Hide Map":"Select on Map",y?e.jsx(Pe,{className:"ml-2 h-4 w-4"}):e.jsx(ke,{className:"ml-2 h-4 w-4"})]})]}),y&&e.jsx("div",{className:"space-y-2 animate-in fade-in slide-in-from-top-2 duration-300",children:e.jsx(Te,{center:ne,zoom:13,onLocationSelect:ye})}),!y&&e.jsxs("div",{className:"space-y-2 relative",children:[e.jsx(_e,{ref:k,type:"text",placeholder:"Start typing your address...",value:v,onChange:xe,disabled:!d,leftIcon:e.jsx(Z,{className:"w-5 h-5"}),rightAction:me?e.jsx(F,{className:"w-4 h-4 animate-spin text-muted-foreground"}):null,inputClassName:"h-12"}),v.length>0&&v.length<5&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Type ",5-v.length," more character",5-v.length!==1?"s":""," to see suggestions..."]}),!d&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Loading address search..."}),pe&&Y.length>0&&e.jsx("div",{ref:P,className:"absolute z-50 w-full mt-1 bg-popover border border-border rounded-md shadow-lg max-h-60 overflow-auto",children:Y.map((o,a)=>{const r=o.placePrediction;if(!r)return null;const p=r.structuredFormat?.mainText?.text||r.text?.text||"",g=r.structuredFormat?.secondaryText?.text||"";return e.jsxs("button",{type:"button",onClick:()=>he(o),className:"w-full text-left px-4 py-3 hover:bg-accent transition-colors border-b border-border last:border-b-0 focus:outline-none focus:bg-accent",children:[e.jsx("div",{className:"font-medium text-foreground",children:p}),g&&e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:g})]},r.placeId||a)})})]}),j&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600 dark:text-green-400",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsxs("span",{children:["Location confirmed: ",j]})]})]}),ue&&j&&e.jsxs("div",{className:"space-y-4 p-4 bg-accent/30 rounded-xl border border-border animate-in fade-in slide-in-from-top-2 duration-300",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ie,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"text-base font-semibold text-foreground",children:"Confirm Your Address"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Please verify your address details are correct."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(f,{htmlFor:"address-line1",children:["Address Line 1 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(w,{id:"address-line1",name:"address_line1",type:"text",placeholder:"House/flat number and street name",value:G,onChange:o=>U(o.target.value),className:"mt-1",required:!0}),t.address_line1&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.address_line1}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"e.g., 123 Main Street or Flat 4, Building Name"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"address-line2",children:"Address Line 2"}),e.jsx(w,{id:"address-line2",name:"address_line2",type:"text",placeholder:"Building name, floor, etc. (optional)",value:le,onChange:o=>R(o.target.value),className:"mt-1"}),t.address_line2&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.address_line2})]}),e.jsxs("div",{children:[e.jsxs(f,{htmlFor:"town-city",children:["Town/City ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(w,{id:"town-city",name:"town_city",type:"text",placeholder:"e.g., London",value:K,onChange:o=>B(o.target.value),className:"mt-1",required:!0}),t.town_city&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.town_city})]}),e.jsxs("div",{children:[e.jsxs(f,{htmlFor:"postcode-display",children:["Postcode ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(w,{id:"postcode-display",name:"postcode",type:"text",value:j,onChange:o=>_(o.target.value),className:"mt-1",required:!0}),t.postcode&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.postcode})]}),e.jsx("input",{type:"hidden",name:"latitude",value:ie||""}),e.jsx("input",{type:"hidden",name:"longitude",value:ce||""})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ae,{id:"is-default",checked:O,onCheckedChange:o=>de(o===!0)}),e.jsx("input",{type:"hidden",name:"is_default",value:O?"1":"0"}),e.jsx(f,{htmlFor:"is-default",className:"text-sm font-medium cursor-pointer",children:"Set as default address"})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(L,{type:"submit",disabled:s||!j||!G.trim()||!K.trim(),className:"flex-1",children:s?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):"Save Address"}),e.jsx(L,{type:"button",variant:"outline",onClick:te,disabled:s,children:"Cancel"})]})]})})}export{$e as A};
